---
layout: false
permalink: /admin/agents/index.html
---
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neo's Office ‚Äî Agent HQ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0f0f1a; display: flex; flex-direction: column; min-height: 100vh; font-family: 'Press Start 2P', monospace; overflow: hidden; }
  h1 { color: #10b981; font-size: 14px; padding: 8px 16px; letter-spacing: 2px; text-align: center; flex-shrink: 0; margin: 0; }
  .admin-nav { display: flex; justify-content: center; gap: 0; flex-shrink: 0; background: #1a1a2e; border-bottom: 2px solid #334155; }
  .admin-nav a { color: #94a3b8; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 15px; font-weight: 600; padding: 12px 28px; text-decoration: none; border-bottom: 3px solid transparent; transition: all 0.2s; }
  .admin-nav a:hover { color: #e2e8f0; background: rgba(255,255,255,0.05); }
  .admin-nav a.active { color: #10b981; border-bottom-color: #10b981; }
  #main-container { display: flex; flex: 1; overflow: hidden; }
  #game-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  #game { image-rendering: auto; -webkit-font-smoothing: antialiased; cursor: crosshair; flex: 1; display: block; width: 100%; }
  #blocked-panel { width: 340px; background: #1a1a2e; border-left: 3px solid #1e3a34; overflow-y: auto; flex-shrink: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  #blocked-panel h2 { color: #f59e0b; font-size: 16px; font-weight: 800; padding: 16px; border-bottom: 2px solid #334155; text-align: center; font-family: 'Press Start 2P', monospace; }
  .blocked-item { padding: 14px 16px; border-bottom: 1px solid #334155; transition: background 0.2s; cursor: pointer; }
  .blocked-item:hover { background: #0f172a; }
  .blocked-item .priority { font-size: 11px; font-weight: 700; margin-bottom: 6px; letter-spacing: 0.5px; }
  .blocked-item .text { font-size: 14px; line-height: 1.5; color: #e2e8f0; font-weight: 500; }
  .blocked-item .type { font-size: 11px; color: #94a3b8; margin-top: 6px; }
  .priority.CRITICAL { color: #ef4444; }
  .priority.HIGH { color: #f59e0b; }
  .priority.MEDIUM { color: #3b82f6; }
  .priority.LOW { color: #6b7280; }
  #bottom { display: flex; flex-shrink: 0; max-height: 30vh; }
  #log { flex: 1; max-height: 30vh; overflow-y: auto; background: #1a1a2e; border: 2px solid #1e3a34; color: #94a3b8; font-size: 8px; padding: 8px; line-height: 1.6; }
  #log .time { color: #047857; } #log .name { color: #e3b23c; } #log .action { color: #cbd5e1; }
  #status { display: flex; gap: 8px; padding: 6px 16px; flex-wrap: wrap; justify-content: center; flex-shrink: 0; background: #1a1a2e; border-top: 2px solid #1e3a34; }
  .agent-badge { background: #0f172a; border: 1px solid #334155; padding: 4px 8px; font-size: 7px; color: #94a3b8; display: flex; align-items: center; gap: 6px; cursor: pointer; transition: border-color 0.2s; }
  .agent-badge:hover { border-color: #10b981; color: #e2e8f0; }
  .agent-badge .dot { width: 6px; height: 6px; border-radius: 50%; }
  a.back { color: #475569; font-size: 8px; text-decoration: none; position: absolute; top: 12px; left: 16px; z-index: 10; }
  a.back:hover { color: #10b981; }
  /* Modal */
  #modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 50; align-items: center; justify-content: center; }
  #modal-overlay.show { display: flex; }
  #modal { background: #1a1a2e; border: 3px solid #10b981; padding: 24px; max-width: 520px; width: 90%; }
  #modal h2 { color: #10b981; font-size: 16px; margin-bottom: 16px; line-height: 1.4; }
  #modal p { color: #e2e8f0; font-size: 15px; margin-bottom: 10px; line-height: 1.7; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  #modal-input { width: 100%; background: #0f172a; border: 2px solid #334155; color: #e2e8f0; font-family: 'Press Start 2P', monospace; font-size: 10px; padding: 10px; margin-top: 10px; outline: none; }
  #modal-input:focus { border-color: #10b981; }
  #modal-btns { display: flex; gap: 8px; margin-top: 12px; }
  #modal-btns button { font-family: 'Press Start 2P', monospace; font-size: 10px; padding: 10px 18px; cursor: pointer; border: 2px solid; background: transparent; }
  #modal-send { color: #10b981; border-color: #10b981; }
  #modal-send:hover { background: #10b981; color: #0f172a; }
  #modal-cancel { color: #94a3b8; border-color: #475569; }
  #modal-cancel:hover { background: #475569; color: #e2e8f0; }
</style>
</head>
<body>
<nav class="admin-nav">
  <a href="/admin/tasks/">üìã Tasks</a>
  <a href="/admin/agents/" class="active">ü§ñ Agents</a>
</nav>
<h1>‚öîÔ∏è NEO'S OFFICE ‚Äî AGENT HQ ‚öîÔ∏è</h1>
<div id="main-container">
  <div id="game-wrapper">
    <canvas id="game"></canvas>
    <div id="status"></div>
    <div id="bottom"><div id="log"></div></div>
  </div>
  <div id="blocked-panel">
    <h2>‚ö†Ô∏è NEEDS ROB</h2>
    <div id="blocked-list"></div>
  </div>
</div>

<div id="modal-overlay">
  <div id="modal">
    <h2 id="modal-title">üìã Instruct Agent</h2>
    <p id="modal-info"></p>
    <input id="modal-input" type="text" placeholder="Type instruction..." maxlength="200" />
    <div id="modal-btns">
      <button id="modal-send">SEND</button>
      <button id="modal-cancel">CANCEL</button>
    </div>
  </div>
</div>

<script>
const C = document.getElementById('game');
const ctx = C.getContext('2d');
const log = document.getElementById('log');
const statusBar = document.getElementById('status');

// --- BLOCKED ITEMS ---
const BLOCKED = [
  { item: "9 writer drafts need Rob's review", type: "APPROVAL", priority: "HIGH", agents: ["Writer"], instructions: "Review drafts in agents/writer/drafts/ ‚Äî sort into robspain.com vs behaviorschool.com per content strategy. Approve or request changes." },
  { item: "9 writer drafts need review", type: "APPROVAL", priority: "HIGH", agents: ["Writer"], instructions: "Review blog drafts. Neo will send you preview links on Telegram ‚Äî read on phone, reply 'approved' or send feedback." },
  { item: "app.behaviorschool.com DNS setup", type: "BLOCKER", priority: "HIGH", agents: ["Pro"], instructions: "Add CNAME record for app.behaviorschool.com pointing to the Vercel/Netlify deployment. Check your domain registrar (Cloudflare?)." },
  { item: "Gmail app password for BAE SIG", type: "BLOCKER", priority: "MEDIUM", agents: ["BAE SIG"], instructions: "Go to myaccount.google.com ‚Üí Security ‚Üí App passwords for california.bae.sig@gmail.com. Generate an app password. Send it to Neo to set as GMAIL_APP_PASSWORD on Vercel." },
  { item: "PayPal link from Liz Flaherty", type: "BLOCKER", priority: "MEDIUM", agents: ["BAE SIG"], instructions: "Ask Liz Flaherty for the PayPal QR/link earmarked 'SIG Reception Donation'. Neo will update the raffle site." },
  { item: "gog auth for Gmail/Calendar", type: "BLOCKER", priority: "MEDIUM", agents: ["Neo", "Scout"], instructions: "When home at Mac mini, run: GOG_KEYRING_BACKEND=file gog auth add robspain@gmail.com --services gmail,calendar,drive,contacts,docs,sheets" },
  { item: "Ahrefs login credentials", type: "BLOCKER", priority: "LOW", agents: ["SEO"], instructions: "Share Ahrefs login with Neo so the SEO agent can run keyword gap analysis and competitor tracking." },
  { item: "Social media account logins", type: "BLOCKER", priority: "LOW", agents: ["Writer", "Browser"], instructions: "Share Instagram, LinkedIn, Facebook, YouTube logins so agents can post approved content directly." },
];

function renderBlockedPanel() {
  const panel = document.getElementById('blocked-list');
  panel.innerHTML = BLOCKED.map((item, i) => `
    <div class="blocked-item" style="cursor:pointer" onclick="showBlockerDetail(${i})">
      <div class="priority ${item.priority}">‚ö† ${item.priority}</div>
      <div class="text">${item.item}</div>
      <div class="type">${item.type} ¬∑ ${item.agents.join(', ')}</div>
    </div>
  `).join('');
}
renderBlockedPanel();

function showBlockerDetail(idx) {
  const b = BLOCKED[idx];
  const overlay = document.getElementById('modal-overlay');
  const title = document.getElementById('modal-title');
  const info = document.getElementById('modal-info');
  const input = document.getElementById('modal-input');
  title.textContent = '‚ö†Ô∏è ' + b.priority + ': ' + b.item;
  info.innerHTML = '<strong style="color:#f59e0b">Blocked agents:</strong> ' + b.agents.join(', ') + '<br><br><strong style="color:#10b981">What Rob needs to do:</strong><br>' + b.instructions;
  input.style.display = 'none';
  document.getElementById('modal-send').style.display = 'none';
  overlay.classList.add('show');
}

// Reset modal for agent instructions
const origCancel = document.getElementById('modal-cancel').onclick;
document.getElementById('modal-cancel').onclick = () => {
  document.getElementById('modal-input').style.display = '';
  document.getElementById('modal-send').style.display = '';
  document.getElementById('modal-overlay').classList.remove('show');
  selectedAgent = null;
};

// --- FULLSCREEN CANVAS ---
let SCALE = 1;
let W = 640, H = 480;
let DPR = 1;
function resizeCanvas() {
  const header = document.querySelector('h1');
  const status = document.getElementById('status');
  const bottom = document.getElementById('bottom');
  const gameWrapper = document.getElementById('game-wrapper');
  const avail = window.innerHeight - (header ? header.offsetHeight : 30) - (status ? status.offsetHeight : 30) - (bottom ? bottom.offsetHeight : 120) - 10;
  const aspect = 640 / 480;
  const wrapperWidth = gameWrapper ? gameWrapper.offsetWidth : window.innerWidth - 280;
  let cw = wrapperWidth;
  let ch = Math.max(avail, 200);
  if (cw / ch > aspect) { cw = ch * aspect; } else { ch = cw / aspect; }
  DPR = Math.min(window.devicePixelRatio || 1, 3);
  C.style.width = wrapperWidth + 'px';
  C.style.height = ch + 'px';
  C.width = Math.round(640 * DPR);
  C.height = Math.round(480 * DPR);
  ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
  SCALE = wrapperWidth / 640;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// --- CLICK TO SELECT AGENT ---
let selectedAgent = null;
const modal = document.getElementById('modal-overlay');
const modalTitle = document.getElementById('modal-title');
const modalInfo = document.getElementById('modal-info');
const modalInput = document.getElementById('modal-input');

C.addEventListener('click', (e) => {
  const rect = C.getBoundingClientRect();
  const mx = (e.clientX - rect.left) / rect.width * 640;
  const my = (e.clientY - rect.top) / rect.height * 480;
  // Find closest agent within 25px
  let closest = null, closestDist = 25;
  AGENTS.forEach(a => {
    const d = Math.hypot(a.x - mx, a.y - my);
    if (d < closestDist) { closest = a; closestDist = d; }
  });
  if (closest) openAgentModal(closest);
});

function openAgentModal(agent) {
  selectedAgent = agent;
  document.getElementById('modal-input').style.display = '';
  document.getElementById('modal-send').style.display = '';
  modalTitle.textContent = agent.icon + ' ' + agent.name + ' ‚Äî ' + agent.role;
  // Show real task if available from activity data
  const realTask = (window.agentActivity && window.agentActivity.agents && window.agentActivity.agents[agent.name])
    ? window.agentActivity.agents[agent.name].task
    : null;
  const statusEmoji = {working:'üü¢',idle:'‚ö™',waiting:'üü°',blocked:'üî¥',deployed:'‚úÖ'}[agent.state] || '‚ö™';
  modalInfo.innerHTML = '<strong style="color:#10b981">Status:</strong> ' + statusEmoji + ' ' + agent.state +
    (realTask ? '<br><br><strong style="color:#f59e0b">Current task:</strong> ' + realTask : '') +
    '<br><br>Type an instruction below and hit SEND:';
  modalInput.value = '';
  modal.classList.add('show');
  modalInput.focus();
}

document.getElementById('modal-send').onclick = sendInstruction;
modalInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendInstruction(); if (e.key === 'Escape') { modal.classList.remove('show'); selectedAgent = null; } });

function sendInstruction() {
  if (!selectedAgent || !modalInput.value.trim()) return;
  const msg = modalInput.value.trim();
  addLog('<span class="name">Rob</span> ‚Üí <span class="name">' + selectedAgent.name + '</span>: <span class="action">"' + msg + '"</span>');
  selectedAgent.bubble = 'üì® ' + msg.substring(0, 20) + (msg.length > 20 ? '...' : '');
  selectedAgent.bubbleTimer = 200;
  spawnParticles(selectedAgent.x, selectedAgent.y, selectedAgent.color, 10);
  // Simulate agent acknowledging
  setTimeout(() => {
    if (selectedAgent) {
      selectedAgent.bubble = pick(['On it!', 'Got it, boss!', 'Starting now...', 'Roger that!', 'Consider it done.']);
      selectedAgent.bubbleTimer = 150;
      addLog('<span class="name">' + selectedAgent.name + '</span> <span class="action">acknowledged task.</span>');
    }
  }, 2000);
  modal.classList.remove('show');
}

// Status bar badges also clickable
statusBar.addEventListener('click', (e) => {
  const badge = e.target.closest('.agent-badge');
  if (!badge) return;
  const name = badge.dataset.agent;
  const agent = AGENTS.find(a => a.name === name);
  if (agent) openAgentModal(agent);
});

// --- COLORS (NES palette) ---
const PAL = {
  floor: '#2a2a3e', wall: '#1e3a34', carpet: '#1a2332', desk: '#5c4033',
  chair: '#3d2b1f', monitor: '#0f172a', monitorGlow: '#10b981',
  water: '#0ea5e9', waterBase: '#475569', plant: '#059669',
  confTable: '#4a3728', whiteboard: '#e2e8f0', doorFrame: '#8b7355'
};

// --- AGENTS ---
const AGENTS = [
  // --- Tier 1: Core Operations ---
  { name: 'Neo', role: 'Chief of Staff', color: '#10b981', accent: '#059669', icon: 'üï∂Ô∏è', x: 320, y: 80, state: 'working', desk: {x:296,y:60}, speed: 1.2 },
  { name: 'Scout', role: 'Research', color: '#f59e0b', accent: '#d97706', icon: 'üîç', x: 100, y: 60, state: 'working', desk: {x:80,y:40}, speed: 0.9 },
  { name: 'Writer', role: 'Content', color: '#8b5cf6', accent: '#7c3aed', icon: '‚úçÔ∏è', x: 100, y: 120, state: 'working', desk: {x:80,y:100}, speed: 0.8 },
  { name: 'Analyst', role: 'Analytics', color: '#ec4899', accent: '#db2777', icon: 'üìä', x: 180, y: 60, state: 'working', desk: {x:170,y:40}, speed: 0.7 },
  { name: 'Engineer', role: 'Developer', color: '#06b6d4', accent: '#0891b2', icon: '‚öôÔ∏è', x: 180, y: 120, state: 'working', desk: {x:170,y:100}, speed: 1.0 },
  { name: 'Planner', role: 'Task Chains', color: '#f97316', accent: '#ea580c', icon: 'üìã', x: 460, y: 60, state: 'working', desk: {x:450,y:40}, speed: 0.85 },
  { name: 'Browser', role: 'Web Agent', color: '#14b8a6', accent: '#0d9488', icon: 'üåê', x: 460, y: 120, state: 'working', desk: {x:450,y:100}, speed: 0.95 },
  { name: 'Docs', role: 'Documents', color: '#a855f7', accent: '#9333ea', icon: 'üìÑ', x: 540, y: 60, state: 'working', desk: {x:530,y:40}, speed: 0.75 },
  { name: 'SEO', role: 'AEO + GEO', color: '#22d3ee', accent: '#06b6d4', icon: 'üîé', x: 540, y: 120, state: 'working', desk: {x:530,y:100}, speed: 0.8 },
  // --- Tier 2: Org Agents ---
  { name: 'BAE SIG', role: 'CalABA Ops', color: '#fbbf24', accent: '#f59e0b', icon: 'üéì', x: 100, y: 195, state: 'working', desk: {x:80,y:175}, speed: 0.7 },
  { name: 'KCUSD', role: 'Schools', color: '#4ade80', accent: '#22c55e', icon: 'üè´', x: 180, y: 195, state: 'working', desk: {x:170,y:175}, speed: 0.65 },
  // --- Tier 3: Repo Agents ---
  { name: 'RobSpain.com', role: 'robspain.com', color: '#34d399', accent: '#10b981', icon: 'üåø', x: 100, y: 280, state: 'working', desk: {x:80,y:260}, speed: 0.7 },
  { name: 'BehaviorSchool', role: 'behaviorschool.com', color: '#047857', accent: '#065f46', icon: 'üìó', x: 180, y: 280, state: 'working', desk: {x:170,y:260}, speed: 0.7 },
  { name: 'Study App', role: 'study.beh...', color: '#fb923c', accent: '#ea580c', icon: 'üì±', x: 260, y: 280, state: 'working', desk: {x:250,y:260}, speed: 0.75 },
  { name: 'Pro', role: 'app.beh...', color: '#a78bfa', accent: '#7c3aed', icon: 'üíé', x: 340, y: 280, state: 'working', desk: {x:330,y:260}, speed: 0.7 },
  { name: 'Supervision', role: 'supervision', color: '#f472b6', accent: '#db2777', icon: 'üë•', x: 420, y: 280, state: 'working', desk: {x:410,y:260}, speed: 0.65 },
  { name: 'Toolchest', role: 'toolchest', color: '#facc15', accent: '#eab308', icon: 'üß∞', x: 500, y: 280, state: 'working', desk: {x:490,y:260}, speed: 0.7 },
  { name: 'VideoGen', role: 'video gen', color: '#f87171', accent: '#ef4444', icon: 'üé¨', x: 100, y: 345, state: 'working', desk: {x:80,y:325}, speed: 0.8 },
  { name: 'Learning', role: 'learning', color: '#38bdf8', accent: '#0284c7', icon: 'üìö', x: 180, y: 345, state: 'working', desk: {x:170,y:325}, speed: 0.65 },
];

// --- OFFICE LAYOUT ---
const ROOMS = {
  coreOps: { x: 50, y: 30, w: 540, h: 130, label: 'CORE OPERATIONS' },
  orgAgents: { x: 50, y: 170, w: 220, h: 60, label: 'ORG AGENTS' },
  repoAgents: { x: 50, y: 245, w: 540, h: 60, label: 'REPO AGENTS' },
  repoAgents2: { x: 50, y: 315, w: 220, h: 55, label: '' },
  confRoom: { x: 290, y: 170, w: 180, h: 110, label: 'CONF ROOM' },
  waterCooler: { x: 500, y: 170, w: 60, h: 60, label: '' },
  neoOffice: { x: 270, y: 30, w: 120, h: 65, label: '' }
};

const CONF_TABLE = { x: 330, y: 200, w: 100, h: 50 };
const WATER_POS = { x: 525, y: 195 };
const WHITEBOARD = { x: 300, y: 172, w: 160, h: 8 };

// --- MESSAGES ---
const WORK_MSGS = {
  Neo: ["Reviewing agent reports...", "Prioritizing tasks...", "Checking heartbeat...", "Deploying updates...", "Reading Rob's messages..."],
  Scout: ["Scanning r/bcba...", "Found a new lead!", "Competitor update...", "Checking Reddit...", "New finding: relevance 8!"],
  Writer: ["Drafting blog post...", "Writing email copy...", "Editing for citations...", "Social post ready!", "Checking tone..."],
  Analyst: ["Running daily report...", "Calculating MRR...", "Tracking engagement...", "Building dashboard...", "Crunching numbers..."],
  Engineer: ["Building feature...", "Fixing bug...", "npm install...", "Pushing to GitHub...", "Code review done!"],
  Planner: ["Decomposing task...", "Step 3 of 7 done!", "Verifying output...", "Checkpoint saved.", "Chaining next step..."],
  Browser: ["Scraping competitor...", "Health check: all ‚úÖ", "Taking screenshot...", "Navigating LinkedIn...", "Extracting data..."],
  Docs: ["Generating PDF...", "Formatting Excel...", "Brand colors applied.", "Report: 3 pages.", "Table styled! ‚úÖ"],
  SEO: ["Adding FAQ schema...", "Rewriting headers...", "AEO quick win found!", "Checking snippets...", "GEO authority score ‚Üë"],
  'BAE SIG': ["Checking raffle sales...", "Ticket emailed! ‚úÖ", "PayPal revenue: $40", "Certificate ready.", "Updating prizes..."],
  KCUSD: ["Team roster updated.", "FBA referral logged.", "Checking caseloads...", "RBT schedule synced.", "26 team members ‚úÖ"],
  'RobSpain.com': ["Building 11ty...", "Hero section fix.", "Admin page updated.", "CV refreshed.", "Deploy to Netlify..."],
  BehaviorSchool: ["Next.js building...", "Nav menu fixed.", "New landing page.", "IEP tool update.", "Checking SEO..."],
  'Study App': ["10K questions loaded.", "Mock exam scored.", "AI Tutor response.", "Stripe checkout OK.", "iOS build running..."],
  Pro: ["FBA-to-BIP draft...", "Goal bank query.", "ACT matrix loaded.", "Convex sync ‚úÖ", "New user signup!"],
  Supervision: ["Directory updated.", "Hour log saved.", "Compliance check ‚úÖ", "Study bridge sync.", "Supervisor matched."],
  Toolchest: ["Data collection...", "Graph rendered.", "BIP template ready.", "Definition written.", "Convex function OK."],
  VideoGen: ["Rendering batch...", "Remotion compose.", "Thumbnail gen.", "Social clip ready!", "Upload to R2..."],
  Learning: ["Course uploaded.", "Video transcoded.", "R2 bucket sync.", "CEU tracker update.", "Module published."]
};

const MEETING_TOPICS = [
  "Content strategy sync", "Competitor deep dive", "Weekly priorities",
  "Revenue review", "New feature planning", "SEO audit results",
  "Blog post review", "Toolchest roadmap", "LinkedIn strategy"
];

const WATER_COOLER_CHAT = [
  ["Did you see that Reddit post?", "Yeah, relevance 9!"],
  ["Rob wants LinkedIn access.", "Browser agent ready!"],
  ["Mock scores content?", "Draft almost done!"],
  ["New competitor found.", "I'll benchmark them."],
  ["Email campaigns ready?", "9 templates done!"],
  ["Planner crushed it.", "9 min flat!"],
];

// --- STATE ---
let tick = 0;
let meetingActive = false;
let meetingTopic = '';
let meetingAgents = [];
let meetingTimer = 0;
let waterCoolerChat = null;
let waterCoolerTimer = 0;
let particles = [];

function addLog(msg) {
  const t = new Date().toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit'});
  log.innerHTML += `<span class="time">[${t}]</span> ${msg}<br>`;
  log.scrollTop = log.scrollHeight;
}

function rand(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }
function pick(arr) { return arr[rand(0, arr.length - 1)]; }
function dist(a, b) { return Math.hypot(a.x - b.x, a.y - b.y); }

// --- DRAWING (16-BIT STYLE) ---
function drawPixelRect(x, y, w, h, color) {
  ctx.fillStyle = color;
  ctx.fillRect(Math.floor(x), Math.floor(y), w, h);
}

function drawGradientRect(x, y, w, h, color1, color2) {
  const grad = ctx.createLinearGradient(x, y, x, y + h);
  grad.addColorStop(0, color1);
  grad.addColorStop(1, color2);
  ctx.fillStyle = grad;
  ctx.fillRect(Math.floor(x), Math.floor(y), w, h);
}

function drawRoundedRect(x, y, w, h, color, shadow = false) {
  if (shadow) {
    ctx.fillStyle = 'rgba(0,0,0,0.25)';
    ctx.beginPath();
    ctx.roundRect(x + 2, y + 2, w, h, 3);
    ctx.fill();
  }
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.roundRect(x, y, w, h, 3);
  ctx.fill();
}

function drawOffice() {
  // Floor: rich wood-tile pattern
  const floorGrad = ctx.createLinearGradient(0, 0, 0, 480);
  floorGrad.addColorStop(0, '#1c1c32');
  floorGrad.addColorStop(0.5, '#181830');
  floorGrad.addColorStop(1, '#14142a');
  ctx.fillStyle = floorGrad;
  ctx.fillRect(0, 0, 640, 480);
  
  // Tile grid overlay
  ctx.strokeStyle = 'rgba(255,255,255,0.03)';
  ctx.lineWidth = 0.5;
  for (let gx = 0; gx < 640; gx += 32) {
    ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, 480); ctx.stroke();
  }
  for (let gy = 0; gy < 480; gy += 32) {
    ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(640, gy); ctx.stroke();
  }

  // Draw rooms with richer gradients + inner glow
  Object.values(ROOMS).forEach(r => {
    // Room floor ‚Äî subtle carpet texture
    const roomGrad = ctx.createRadialGradient(r.x + r.w/2, r.y + r.h/2, 10, r.x + r.w/2, r.y + r.h/2, Math.max(r.w, r.h));
    roomGrad.addColorStop(0, '#30304a');
    roomGrad.addColorStop(1, '#24243a');
    ctx.fillStyle = roomGrad;
    ctx.beginPath();
    ctx.roundRect(r.x, r.y, r.w, r.h, 4);
    ctx.fill();
    // Border with depth
    ctx.strokeStyle = '#3d5a50';
    ctx.lineWidth = 2;
    ctx.strokeRect(r.x, r.y, r.w, r.h);
    ctx.strokeStyle = 'rgba(16,185,129,0.15)';
    ctx.lineWidth = 1;
    ctx.strokeRect(r.x + 1, r.y + 1, r.w - 2, r.h - 2);
    if (r.label) {
      ctx.fillStyle = '#5a6b7a';
      ctx.font = '6px "Press Start 2P"';
      ctx.fillText(r.label, r.x + 6, r.y + r.h - 4);
    }
  });

  // Neo's office ‚Äî premium glow
  const neoGrad = ctx.createRadialGradient(320, 60, 10, 320, 60, 80);
  neoGrad.addColorStop(0, '#383860');
  neoGrad.addColorStop(1, '#2a2a48');
  ctx.fillStyle = neoGrad;
  ctx.beginPath();
  ctx.roundRect(ROOMS.neoOffice.x, ROOMS.neoOffice.y, ROOMS.neoOffice.w, ROOMS.neoOffice.h, 4);
  ctx.fill();
  ctx.strokeStyle = '#10b981';
  ctx.lineWidth = 2;
  ctx.strokeRect(ROOMS.neoOffice.x, ROOMS.neoOffice.y, ROOMS.neoOffice.w, ROOMS.neoOffice.h);
  // Glow aura
  ctx.shadowColor = '#10b981';
  ctx.shadowBlur = 8;
  ctx.strokeRect(ROOMS.neoOffice.x, ROOMS.neoOffice.y, ROOMS.neoOffice.w, ROOMS.neoOffice.h);
  ctx.shadowBlur = 0;

  // Conference room ‚Äî warm lighting
  const confGrad = ctx.createRadialGradient(380, 225, 10, 380, 225, 90);
  confGrad.addColorStop(0, '#2e2e50');
  confGrad.addColorStop(1, '#222240');
  ctx.fillStyle = confGrad;
  ctx.beginPath();
  ctx.roundRect(ROOMS.confRoom.x, ROOMS.confRoom.y, ROOMS.confRoom.w, ROOMS.confRoom.h, 4);
  ctx.fill();

  // Hallways with subtle lighting
  [[280, 160, 80, 12], [280, 230, 80, 17], [50, 230, 200, 17], [50, 305, 200, 12]].forEach(([hx,hy,hw,hh]) => {
    const hGrad = ctx.createLinearGradient(hx, hy, hx + hw, hy);
    hGrad.addColorStop(0, '#22223a');
    hGrad.addColorStop(0.5, '#282844');
    hGrad.addColorStop(1, '#22223a');
    ctx.fillStyle = hGrad;
    ctx.fillRect(hx, hy, hw, hh);
  });

  // --- FURNITURE (16-bit SNES quality) ---

  // Desks with wood grain, monitor glow, and desk accessories
  AGENTS.forEach(a => {
    const dx = a.desk.x, dy = a.desk.y;
    const isNeo = a.name === 'Neo';
    const dw = isNeo ? 48 : 36, dh = isNeo ? 32 : 24;
    
    // Desk shadow
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.beginPath();
    ctx.roundRect(dx - (isNeo?4:2) + 2, dy - (isNeo?4:2) + 2, dw, dh, 3);
    ctx.fill();
    
    // Desk surface with wood grain
    const woodGrad = ctx.createLinearGradient(dx, dy, dx + dw, dy + dh);
    woodGrad.addColorStop(0, '#7a6050');
    woodGrad.addColorStop(0.3, '#6e5545');
    woodGrad.addColorStop(0.6, '#7a6050');
    woodGrad.addColorStop(1, '#5c4033');
    ctx.fillStyle = woodGrad;
    ctx.beginPath();
    ctx.roundRect(dx - (isNeo?4:2), dy - (isNeo?4:2), dw, dh, 3);
    ctx.fill();
    // Wood grain lines
    ctx.strokeStyle = 'rgba(90,64,51,0.4)';
    ctx.lineWidth = 0.5;
    for (let g = 0; g < 3; g++) {
      const gy = dy + g * (dh/3);
      ctx.beginPath(); ctx.moveTo(dx, gy); ctx.lineTo(dx + dw - 6, gy); ctx.stroke();
    }
    // Desk edge highlight
    ctx.strokeStyle = 'rgba(255,255,255,0.08)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(dx - (isNeo?4:2), dy - (isNeo?4:2));
    ctx.lineTo(dx - (isNeo?4:2) + dw, dy - (isNeo?4:2));
    ctx.stroke();
    
    // Monitor with bezel
    const mx = isNeo ? dx + 8 : dx + 6;
    const my = isNeo ? dy : dy + 2;
    const mw = isNeo ? 20 : 14, mh = isNeo ? 12 : 10;
    // Monitor bezel
    ctx.fillStyle = '#2a2a3e';
    ctx.beginPath();
    ctx.roundRect(mx - 1, my - 1, mw + 2, mh + 2, 2);
    ctx.fill();
    // Screen
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(mx, my, mw, mh);
    // Screen glow (agent color)
    const glowGrad = ctx.createRadialGradient(mx + mw/2, my + mh/2, 2, mx + mw/2, my + mh/2, mw);
    glowGrad.addColorStop(0, a.color);
    glowGrad.addColorStop(1, 'rgba(15,23,42,0.1)');
    ctx.fillStyle = glowGrad;
    ctx.fillRect(mx + 1, my + 1, mw - 2, mh - 2);
    // Monitor stand
    ctx.fillStyle = '#3a3a4e';
    ctx.fillRect(mx + mw/2 - 2, my + mh, 4, 3);
    
    // Coffee mug (small detail)
    if (Math.abs(a.x - (dx + 12)) < 30) {
      ctx.fillStyle = '#e2e8f0';
      ctx.beginPath();
      ctx.roundRect(dx + dw - 10, dy + 2, 5, 6, 1);
      ctx.fill();
      ctx.fillStyle = a.color;
      ctx.fillRect(dx + dw - 9, dy + 3, 3, 2);
    }
  });

  // Conference table ‚Äî polished wood with reflection
  const ctGrad = ctx.createLinearGradient(CONF_TABLE.x, CONF_TABLE.y, CONF_TABLE.x, CONF_TABLE.y + CONF_TABLE.h);
  ctGrad.addColorStop(0, '#6a5740');
  ctGrad.addColorStop(0.5, '#5a4738');
  ctGrad.addColorStop(1, '#4a3728');
  ctx.fillStyle = ctGrad;
  ctx.beginPath();
  ctx.roundRect(CONF_TABLE.x, CONF_TABLE.y, CONF_TABLE.w, CONF_TABLE.h, 4);
  ctx.fill();
  // Table reflection
  ctx.fillStyle = 'rgba(255,255,255,0.05)';
  ctx.beginPath();
  ctx.roundRect(CONF_TABLE.x + 5, CONF_TABLE.y + 3, CONF_TABLE.w - 10, CONF_TABLE.h/3, 2);
  ctx.fill();
  // Chairs with cushions
  for (let i = 0; i < 4; i++) {
    const cx = CONF_TABLE.x + 10 + i * 22;
    // Top chairs
    ctx.fillStyle = '#3d2b1f';
    ctx.beginPath(); ctx.roundRect(cx, CONF_TABLE.y - 10, 12, 8, 2); ctx.fill();
    ctx.fillStyle = '#5a4738';
    ctx.beginPath(); ctx.roundRect(cx + 2, CONF_TABLE.y - 8, 8, 4, 1); ctx.fill();
    // Bottom chairs
    ctx.fillStyle = '#3d2b1f';
    ctx.beginPath(); ctx.roundRect(cx, CONF_TABLE.y + CONF_TABLE.h + 2, 12, 8, 2); ctx.fill();
    ctx.fillStyle = '#5a4738';
    ctx.beginPath(); ctx.roundRect(cx + 2, CONF_TABLE.y + CONF_TABLE.h + 4, 8, 4, 1); ctx.fill();
  }

  // Whiteboard with frame and content
  // Frame
  ctx.fillStyle = '#b0a890';
  ctx.beginPath();
  ctx.roundRect(WHITEBOARD.x - 2, WHITEBOARD.y - 2, WHITEBOARD.w + 4, WHITEBOARD.h + 14, 2);
  ctx.fill();
  // Board surface
  const wbGrad = ctx.createLinearGradient(WHITEBOARD.x, WHITEBOARD.y, WHITEBOARD.x, WHITEBOARD.y + 12);
  wbGrad.addColorStop(0, '#f8f8fc');
  wbGrad.addColorStop(1, '#e8e8f0');
  ctx.fillStyle = wbGrad;
  ctx.fillRect(WHITEBOARD.x, WHITEBOARD.y, WHITEBOARD.w, WHITEBOARD.h + 10);
  ctx.fillStyle = '#059669';
  ctx.font = '6px "Press Start 2P"';
  ctx.fillText(meetingActive ? meetingTopic : 'AGENT HQ ‚Äî SHIP IT', WHITEBOARD.x + 4, WHITEBOARD.y + 8);
  // Marker tray
  ctx.fillStyle = '#8a8a9a';
  ctx.fillRect(WHITEBOARD.x + 10, WHITEBOARD.y + WHITEBOARD.h + 10, 60, 2);
  // Colored markers
  ['#ef4444','#22c55e','#3b82f6'].forEach((mc, mi) => {
    ctx.fillStyle = mc;
    ctx.fillRect(WHITEBOARD.x + 15 + mi * 12, WHITEBOARD.y + WHITEBOARD.h + 7, 8, 3);
  });

  // Water cooler ‚Äî more detailed
  // Base unit
  const wcGrad = ctx.createLinearGradient(WATER_POS.x - 10, WATER_POS.y - 8, WATER_POS.x + 10, WATER_POS.y + 16);
  wcGrad.addColorStop(0, '#7a8a9a');
  wcGrad.addColorStop(1, PAL.waterBase);
  ctx.fillStyle = wcGrad;
  ctx.beginPath();
  ctx.roundRect(WATER_POS.x - 10, WATER_POS.y - 8, 20, 28, 3);
  ctx.fill();
  // Water bottle
  const bottleGrad = ctx.createLinearGradient(WATER_POS.x - 6, WATER_POS.y - 18, WATER_POS.x + 6, WATER_POS.y - 4);
  bottleGrad.addColorStop(0, '#38d9f5');
  bottleGrad.addColorStop(0.5, '#22d3ee');
  bottleGrad.addColorStop(1, '#0ea5e9');
  ctx.fillStyle = bottleGrad;
  ctx.beginPath();
  ctx.roundRect(WATER_POS.x - 6, WATER_POS.y - 18, 12, 14, 3);
  ctx.fill();
  // Water level shimmer
  ctx.fillStyle = 'rgba(255,255,255,0.15)';
  ctx.beginPath();
  ctx.roundRect(WATER_POS.x - 4, WATER_POS.y - 16, 4, 10, 1);
  ctx.fill();
  // Bubbles (animated)
  const bubblePhase = (tick % 60) / 60;
  ctx.globalAlpha = 0.6 + Math.sin(bubblePhase * Math.PI * 2) * 0.3;
  ctx.fillStyle = '#7dd3fc';
  ctx.beginPath();
  ctx.arc(WATER_POS.x - 1, WATER_POS.y - 16 - bubblePhase * 8, 2, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.arc(WATER_POS.x + 2, WATER_POS.y - 14 - ((bubblePhase + 0.3) % 1) * 8, 1.5, 0, Math.PI * 2);
  ctx.fill();
  ctx.globalAlpha = 1;
  // Cups
  ctx.fillStyle = '#e2e8f0';
  ctx.beginPath(); ctx.roundRect(WATER_POS.x + 12, WATER_POS.y - 2, 4, 5, 1); ctx.fill();
  ctx.beginPath(); ctx.roundRect(WATER_POS.x + 12, WATER_POS.y + 5, 4, 5, 1); ctx.fill();

  // Plants ‚Äî more detailed with multiple leaves
  [[55, 35], [580, 35], [55, 250], [580, 250], [55, 320]].forEach(([px, py]) => {
    // Pot with rim
    ctx.fillStyle = '#8B4513';
    ctx.beginPath(); ctx.roundRect(px - 1, py + 2, 10, 10, 2); ctx.fill();
    ctx.fillStyle = '#A0522D';
    ctx.fillRect(px - 2, py + 2, 12, 3);
    // Soil
    ctx.fillStyle = '#3E2723';
    ctx.fillRect(px, py + 3, 8, 2);
    // Leaves (3 layers)
    const leafColors = ['#059669', '#10b981', '#34d399'];
    leafColors.forEach((lc, li) => {
      ctx.fillStyle = lc;
      ctx.beginPath();
      ctx.arc(px + 4 + (li-1)*3, py - li*2, 5 - li, 0, Math.PI * 2);
      ctx.fill();
    });
  });

  // Labels
  ctx.fillStyle = '#5a6b7a';
  ctx.font = '6px "Press Start 2P"';
  ctx.fillText('‚òï', WATER_POS.x - 5, WATER_POS.y + 30);

  // Neo's office label with glow
  ctx.shadowColor = '#10b981';
  ctx.shadowBlur = 6;
  ctx.fillStyle = '#10b981';
  ctx.fillText("NEO", 315, 42);
  ctx.shadowBlur = 0;

  // Agent count
  ctx.fillStyle = '#475569';
  ctx.font = '5px "Press Start 2P"';
  ctx.fillText(AGENTS.length + ' AGENTS ONLINE', 250, 475);
}

function drawAgent(a) {
  const bx = Math.floor(a.x);
  const by = Math.floor(a.y);

  // Drop shadow (16-bit style with blur)
  ctx.save();
  ctx.shadowColor = 'rgba(0,0,0,0.5)';
  ctx.shadowBlur = 4;
  ctx.shadowOffsetX = 2;
  ctx.shadowOffsetY = 3;
  ctx.fillStyle = 'rgba(0,0,0,0.2)';
  ctx.beginPath();
  ctx.ellipse(bx + 3, by + 13, 8, 3, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();

  // Body with gradient (16-bit smooth shading)
  const bodyGrad = ctx.createLinearGradient(bx - 4, by - 2, bx + 8, by + 12);
  bodyGrad.addColorStop(0, a.color);
  bodyGrad.addColorStop(1, a.accent);
  ctx.fillStyle = bodyGrad;
  ctx.beginPath();
  ctx.roundRect(bx - 4, by - 2, 12, 14, 2);
  ctx.fill();

  // Head (rounded, with gradient for depth)
  const headGrad = ctx.createRadialGradient(bx + 1, by - 5, 2, bx + 2, by - 4, 7);
  headGrad.addColorStop(0, lightenColor(a.accent, 20));
  headGrad.addColorStop(1, a.accent);
  ctx.fillStyle = headGrad;
  ctx.beginPath();
  ctx.arc(bx + 2, by - 4, 6, 0, Math.PI * 2);
  ctx.fill();

  // Eyes (white with highlights)
  ctx.fillStyle = '#fff';
  ctx.beginPath();
  ctx.arc(bx, by - 5, 2, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.arc(bx + 5, by - 5, 2, 0, Math.PI * 2);
  ctx.fill();
  
  // Pupils
  ctx.fillStyle = '#000';
  ctx.beginPath();
  ctx.arc(bx + 0.5, by - 4.5, 1.2, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.arc(bx + 5.5, by - 4.5, 1.2, 0, Math.PI * 2);
  ctx.fill();

  // Eye highlights (16-bit detail)
  ctx.fillStyle = 'rgba(255,255,255,0.6)';
  ctx.fillRect(bx - 0.5, by - 6, 1, 1);
  ctx.fillRect(bx + 4.5, by - 6, 1, 1);

  // Walking animation (smoother with more frames)
  if (a.state === 'walking' || a.state === 'toMeeting' || a.state === 'toWater' || a.state === 'toDesk') {
    const legPhase = (tick * 0.15) % (Math.PI * 2);
    const leftLeg = Math.sin(legPhase) * 4;
    const rightLeg = Math.sin(legPhase + Math.PI) * 4;
    
    // Left leg with gradient
    const leftGrad = ctx.createLinearGradient(bx - 2, by + 12, bx, by + 16);
    leftGrad.addColorStop(0, a.accent);
    leftGrad.addColorStop(1, darkenColor(a.accent, 15));
    ctx.fillStyle = leftGrad;
    ctx.beginPath();
    ctx.roundRect(bx - 2, by + 12, 4, 4 + Math.abs(leftLeg), 1);
    ctx.fill();
    
    // Right leg with gradient
    const rightGrad = ctx.createLinearGradient(bx + 3, by + 12, bx + 5, by + 16);
    rightGrad.addColorStop(0, a.accent);
    rightGrad.addColorStop(1, darkenColor(a.accent, 15));
    ctx.fillStyle = rightGrad;
    ctx.beginPath();
    ctx.roundRect(bx + 3, by + 12, 4, 4 + Math.abs(rightLeg), 1);
    ctx.fill();
  } else {
    // Standing legs with gradient
    const legGrad = ctx.createLinearGradient(bx - 2, by + 12, bx + 5, by + 16);
    legGrad.addColorStop(0, a.accent);
    legGrad.addColorStop(1, darkenColor(a.accent, 15));
    ctx.fillStyle = legGrad;
    ctx.beginPath();
    ctx.roundRect(bx - 2, by + 12, 4, 4, 1);
    ctx.fill();
    ctx.beginPath();
    ctx.roundRect(bx + 3, by + 12, 4, 4, 1);
    ctx.fill();
  }

  // Status indicator dot
  const real = window.agentActivity && window.agentActivity.agents[a.name];
  if (real) {
    const statusColors = {working:'#22c55e',idle:'#6b7280',waiting:'#f59e0b',blocked:'#ef4444',deployed:'#10b981'};
    const sc = statusColors[real.status] || '#6b7280';
    ctx.fillStyle = sc;
    ctx.beginPath();
    ctx.arc(bx + 10, by - 14, 3, 0, Math.PI * 2);
    ctx.fill();
    // Pulse for working
    if (real.status === 'working') {
      ctx.globalAlpha = 0.3 + Math.sin(tick * 0.1) * 0.2;
      ctx.beginPath();
      ctx.arc(bx + 10, by - 14, 5, 0, Math.PI * 2);
      ctx.fill();
      ctx.globalAlpha = 1;
    }
  }

  // Dim idle/blocked agents
  if (real && (real.status === 'idle')) {
    ctx.globalAlpha = 0.5;
  }

  // Name tag (pixel font preserved)
  ctx.fillStyle = a.color;
  ctx.font = '6px "Press Start 2P"';
  const nameW = ctx.measureText(a.name).width;
  ctx.fillText(a.name, bx - nameW / 2 + 3, by - 12);
  ctx.globalAlpha = 1;
}

// Helper functions for color manipulation
function lightenColor(hex, percent) {
  const num = parseInt(hex.replace('#',''), 16);
  const amt = Math.round(2.55 * percent);
  const R = Math.min(255, (num >> 16) + amt);
  const G = Math.min(255, ((num >> 8) & 0x00FF) + amt);
  const B = Math.min(255, (num & 0x0000FF) + amt);
  return '#' + ((R << 16) | (G << 8) | B).toString(16).padStart(6, '0');
}

function darkenColor(hex, percent) {
  const num = parseInt(hex.replace('#',''), 16);
  const amt = Math.round(2.55 * percent);
  const R = Math.max(0, (num >> 16) - amt);
  const G = Math.max(0, ((num >> 8) & 0x00FF) - amt);
  const B = Math.max(0, (num & 0x0000FF) - amt);
  return '#' + ((R << 16) | (G << 8) | B).toString(16).padStart(6, '0');
}

function drawBubble(x, y, text, color) {
  ctx.font = '6px "Press Start 2P"';
  const w = Math.min(ctx.measureText(text).width + 12, 160);
  const bx = x - w / 2;
  const by = y - 28;

  ctx.fillStyle = 'rgba(15,23,42,0.9)';
  ctx.fillRect(bx, by, w, 16);
  ctx.strokeStyle = color;
  ctx.lineWidth = 1;
  ctx.strokeRect(bx, by, w, 16);

  // Tail
  ctx.fillStyle = 'rgba(15,23,42,0.9)';
  ctx.fillRect(x - 3, by + 16, 6, 4);

  ctx.fillStyle = color;
  const displayText = text.length > 26 ? text.substring(0, 24) + '..' : text;
  ctx.fillText(displayText, bx + 6, by + 11);
}

function drawParticles() {
  particles = particles.filter(p => p.life > 0);
  particles.forEach(p => {
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.05; // Gravity
    p.vx *= 0.98; // Air resistance
    p.life--;
    
    // 16-bit style: smooth alpha blending with glow
    const alpha = p.life / p.maxLife;
    ctx.globalAlpha = alpha;
    
    // Glow effect
    const glowGrad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size * 2);
    glowGrad.addColorStop(0, p.color);
    glowGrad.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = glowGrad;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size * 2, 0, Math.PI * 2);
    ctx.fill();
    
    // Core particle
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();
  });
  ctx.globalAlpha = 1;
}

function spawnParticles(x, y, color, count) {
  for (let i = 0; i < count; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = Math.random() * 2 + 0.5;
    particles.push({
      x, y, 
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed - 1,
      life: rand(20, 40), 
      maxLife: 40, 
      color,
      size: Math.random() * 1.5 + 1
    });
  }
}

// --- AI BEHAVIOR ---
function moveToward(agent, tx, ty) {
  const dx = tx - agent.x;
  const dy = ty - agent.y;
  const d = Math.hypot(dx, dy);
  if (d < 3) return true;
  agent.x += (dx / d) * agent.speed;
  agent.y += (dy / d) * agent.speed;
  return false;
}

function updateAgents() {
  const hasRealData = !!window.agentActivity;
  AGENTS.forEach(a => {
    switch (a.state) {
      case 'working':
        if (hasRealData) {
          // Show real task, refresh periodically
          const real = window.agentActivity.agents[a.name];
          if (real && rand(0, 300) === 0) {
            a.bubble = real.task;
            a.bubbleTimer = 200;
          }
          // No random wandering with real data ‚Äî only walk if idle
          if (real && real.status === 'idle' && rand(0, 800) === 0 && !meetingActive) {
            a.state = 'walking';
            a.targetX = a.desk.x + rand(-20, 20);
            a.targetY = a.desk.y + rand(-10, 15);
          }
        } else {
          // Fallback: simulated messages
          if (rand(0, 200) === 0) {
            a.bubble = pick(WORK_MSGS[a.name]);
            a.bubbleTimer = 120;
          }
          if (rand(0, 500) === 0 && !meetingActive) {
            a.state = 'walking';
            a.targetX = a.desk.x + rand(-40, 40);
            a.targetY = a.desk.y + rand(-20, 30);
          }
        }
        break;

      case 'walking':
        if (moveToward(a, a.targetX, a.targetY)) {
          a.state = 'toDesk';
        }
        break;

      case 'toDesk':
        if (moveToward(a, a.desk.x + 12, a.desk.y + 20)) {
          a.state = 'working';
          spawnParticles(a.x, a.y, a.color, 5);
        }
        break;

      case 'toMeeting':
        {
          const idx = meetingAgents.indexOf(a);
          const seat = getMeetingSeat(idx);
          if (moveToward(a, seat.x, seat.y)) {
            a.state = 'inMeeting';
          }
        }
        break;

      case 'inMeeting':
        if (rand(0, 60) === 0) {
          a.bubble = pick([meetingTopic, "Good point!", "I agree.", "Let me check...", "Data says...", "Ship it!"]);
          a.bubbleTimer = 90;
        }
        break;

      case 'toWater':
        {
          const wx = WATER_POS.x + rand(-20, 20);
          const wy = WATER_POS.y + rand(10, 25);
          if (moveToward(a, wx, wy)) {
            a.state = 'atWater';
            a.waterTimer = rand(100, 200);
          }
        }
        break;

      case 'atWater':
        a.waterTimer--;
        if (a.waterTimer <= 0) {
          a.state = 'toDesk';
        }
        break;
    }

    // Bubble timer
    if (a.bubbleTimer > 0) a.bubbleTimer--;
    if (a.bubbleTimer === 0) a.bubble = null;
  });
}

function getMeetingSeat(idx) {
  const seats = [
    { x: CONF_TABLE.x + 15, y: CONF_TABLE.y - 16 },
    { x: CONF_TABLE.x + 45, y: CONF_TABLE.y - 16 },
    { x: CONF_TABLE.x + 75, y: CONF_TABLE.y - 16 },
    { x: CONF_TABLE.x + 15, y: CONF_TABLE.y + CONF_TABLE.h + 8 },
    { x: CONF_TABLE.x + 45, y: CONF_TABLE.y + CONF_TABLE.h + 8 },
    { x: CONF_TABLE.x + 75, y: CONF_TABLE.y + CONF_TABLE.h + 8 },
  ];
  return seats[idx % seats.length];
}

function triggerMeeting() {
  if (meetingActive) return;
  meetingActive = true;
  meetingTopic = pick(MEETING_TOPICS);
  meetingTimer = rand(400, 600);
  // Pick 3-5 agents for meeting
  const count = rand(3, 5);
  const shuffled = [...AGENTS].sort(() => Math.random() - 0.5);
  meetingAgents = shuffled.slice(0, count);
  meetingAgents.forEach(a => { a.state = 'toMeeting'; });
  addLog(`<span class="name">${meetingAgents.map(a=>a.name).join(', ')}</span> <span class="action">‚Üí Meeting: "${meetingTopic}"</span>`);
  spawnParticles(280, 350, '#e3b23c', 15);
}

function endMeeting() {
  meetingActive = false;
  meetingAgents.forEach(a => { a.state = 'toDesk'; });
  addLog(`<span class="action">Meeting ended: "${meetingTopic}"</span>`);
  meetingAgents = [];
  meetingTopic = '';
}

function triggerWaterCooler() {
  if (waterCoolerChat) return;
  const available = AGENTS.filter(a => a.state === 'working');
  if (available.length < 2) return;
  const pair = available.sort(() => Math.random() - 0.5).slice(0, 2);
  waterCoolerChat = pair;
  waterCoolerTimer = rand(150, 250);
  pair.forEach(a => { a.state = 'toWater'; });
  const chat = pick(WATER_COOLER_CHAT);
  setTimeout(() => {
    if (pair[0]) { pair[0].bubble = chat[0]; pair[0].bubbleTimer = 120; }
  }, 2000);
  setTimeout(() => {
    if (pair[1]) { pair[1].bubble = chat[1]; pair[1].bubbleTimer = 120; }
  }, 3500);
  addLog(`<span class="name">${pair[0].name}</span> and <span class="name">${pair[1].name}</span> <span class="action">‚Üí Water cooler chat ‚òï</span>`);
}

// --- MAIN LOOP ---
function update() {
  tick++;
  updateAgents();

  // Trigger events ‚Äî much less with real data (mostly visual filler off)
  const meetFreq = window.agentActivity ? 3000 : 600;
  const waterFreq = window.agentActivity ? 2000 : 400;
  if (tick % meetFreq === 300 && !meetingActive) triggerMeeting();
  if (tick % waterFreq === 200 && !waterCoolerChat) triggerWaterCooler();

  // Meeting timer
  if (meetingActive) {
    meetingTimer--;
    if (meetingTimer <= 0) endMeeting();
  }

  // Water cooler timer
  if (waterCoolerChat) {
    waterCoolerTimer--;
    if (waterCoolerTimer <= 0) {
      waterCoolerChat.forEach(a => { if (a.state === 'atWater') a.state = 'toDesk'; });
      waterCoolerChat = null;
    }
  }
}

function render() {
  drawOffice();
  // Sort agents by Y for depth
  const sorted = [...AGENTS].sort((a, b) => a.y - b.y);
  sorted.forEach(a => {
    drawAgent(a);
    if (a.bubble && a.bubbleTimer > 0) {
      drawBubble(a.x + 3, a.y - 10, a.bubble, a.color);
    }
  });
  drawParticles();

  // Meeting indicator
  if (meetingActive) {
    ctx.fillStyle = '#e3b23c';
    ctx.font = '7px "Press Start 2P"';
    ctx.fillText('üì¢ MEETING', 245, 288);
  }
}

function gameLoop() {
  update();
  render();
  requestAnimationFrame(gameLoop);
}

// --- STATUS BAR ---
function updateStatus() {
  statusBar.innerHTML = AGENTS.map(a => {
    const real = window.agentActivity && window.agentActivity.agents[a.name];
    let stateLabel;
    if (real) {
      stateLabel = {working:'üü¢',idle:'‚ö™',waiting:'üü°',blocked:'üî¥',deployed:'‚úÖ'}[real.status] || '‚ùì';
    } else {
      stateLabel = {working:'üíª',walking:'üö∂',toMeeting:'üèÉ',inMeeting:'üó£Ô∏è',toWater:'üö∂',atWater:'‚òï',toDesk:'üèÉ'}[a.state] || '?';
    }
    return `<div class="agent-badge" data-agent="${a.name}"><span class="dot" style="background:${a.color}"></span>${a.icon} ${a.name} ${stateLabel}</div>`;
  }).join('');
}
setInterval(updateStatus, 500);

// --- LOAD REAL ACTIVITY DATA ---
window.agentActivity = null;
fetch('/public/data/agent-activity.json')
  .then(r => r.json())
  .then(data => {
    window.agentActivity = data;
    // Update agent states and bubbles with real data
    AGENTS.forEach(a => {
      const real = data.agents[a.name];
      if (real) {
        a.bubble = real.task;
        a.bubbleTimer = 600; // Show for a long time
        if (real.status === 'blocked') a.state = 'working'; // still show them, but bubble shows blocked
      }
    });
    // Log recent activity
    if (data.recentActivity) {
      data.recentActivity.slice().reverse().forEach(act => {
        addLog('<span class="time">[' + act.time + ']</span> <span class="name">' + act.agent + '</span> <span class="action">' + act.action + '</span>');
      });
    }
    addLog('<span class="action">üì° Loaded real agent activity data.</span>');
  })
  .catch(() => {
    addLog('<span class="action">‚ö†Ô∏è Could not load activity data ‚Äî showing simulation.</span>');
  });

// --- INIT ---
addLog('<span class="action">üè¢ Agent HQ online. ' + AGENTS.length + ' agents reporting for duty.</span>');
addLog('<span class="name">Neo</span> <span class="action">Good morning team. Let\'s ship.</span>');

// Stagger initial meetings ‚Äî less frequent when real data loaded
setTimeout(() => { if (!window.agentActivity) triggerMeeting(); }, 5000);
setTimeout(() => { if (!window.agentActivity) triggerWaterCooler(); }, 8000);

gameLoop();
</script>
</body>
</html>
