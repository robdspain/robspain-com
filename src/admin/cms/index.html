<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <!-- Identity Widget for Netlify Auth -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    /* Custom Login Page Styling */
    #nc-root div[class*="nc-login-logo"] {
      background-image: url('/public/images/icon/robspain-icon.png') !important;
      background-size: contain !important;
      background-repeat: no-repeat !important;
      background-position: center !important;
      width: 120px !important;
      height: 120px !important;
      margin-bottom: 0 !important;
    }
    #nc-root div[class*="nc-login-logo"] svg {
      display: none !important;
    }
    #nc-root div[class*="nc-login-container"]::before {
      content: 'robspain.com';
      display: block;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 2.5rem;
      font-weight: 800;
      color: #059669;
      margin-bottom: 2rem;
      text-align: center;
      letter-spacing: -0.05em;
    }
    #nc-root div[class*="nc-login-container"] {
      background-color: #f8fafc !important;
    }
    #nc-root button[class*="nc-login-button"] {
      background-color: #059669 !important;
      color: white !important;
      border-radius: 12px !important;
      padding: 12px 24px !important;
      font-weight: 600 !important;
      transition: all 0.3s ease !important;
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2) !important;
    }
    #nc-root button[class*="nc-login-button"]:hover {
      background-color: #047857 !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 8px 20px rgba(5, 150, 105, 0.3) !important;
    }

    /* Tiptap Editor Styles */
    .tiptap-wrapper {
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
    }
    .tiptap-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 8px 12px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }
    .tiptap-toolbar button {
      padding: 6px 10px;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #475569;
      transition: all 0.15s ease;
    }
    .tiptap-toolbar button:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }
    .tiptap-toolbar button.is-active {
      background: #059669;
      color: #fff;
      border-color: #059669;
    }
    .tiptap-toolbar .separator {
      width: 1px;
      background: #e2e8f0;
      margin: 0 4px;
    }
    .tiptap-editor {
      padding: 16px;
      min-height: 300px;
      max-height: 600px;
      overflow-y: auto;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 16px;
      line-height: 1.7;
      color: #1e293b;
    }
    .tiptap-editor:focus {
      outline: none;
    }
    .tiptap-editor p {
      margin: 0 0 1em 0;
    }
    .tiptap-editor h1, .tiptap-editor h2, .tiptap-editor h3 {
      font-weight: 700;
      line-height: 1.3;
      margin: 1.5em 0 0.5em 0;
    }
    .tiptap-editor h1 { font-size: 2rem; }
    .tiptap-editor h2 { font-size: 1.5rem; border-bottom: 2px solid #10B981; padding-bottom: 0.25em; }
    .tiptap-editor h3 { font-size: 1.25rem; color: #10B981; }
    .tiptap-editor ul, .tiptap-editor ol {
      padding-left: 1.5em;
      margin: 1em 0;
    }
    .tiptap-editor li { margin-bottom: 0.5em; }
    .tiptap-editor blockquote {
      border-left: 4px solid #10B981;
      padding-left: 1em;
      margin: 1em 0;
      font-style: italic;
      color: #64748b;
    }
    .tiptap-editor code {
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.9em;
    }
    .tiptap-editor pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 1em;
      border-radius: 8px;
      overflow-x: auto;
    }
    .tiptap-editor pre code {
      background: none;
      padding: 0;
      color: inherit;
    }
    .tiptap-editor a {
      color: #059669;
      text-decoration: underline;
    }
    .tiptap-editor hr {
      border: none;
      border-top: 2px solid #e2e8f0;
      margin: 2em 0;
    }
    .tiptap-editor img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }
    .tiptap-editor .ProseMirror-selectednode {
      outline: 2px solid #059669;
    }
    .tiptap-editor p.is-editor-empty:first-child::before {
      content: attr(data-placeholder);
      color: #94a3b8;
      pointer-events: none;
      float: left;
      height: 0;
    }
    .tiptap-editor .youtube-embed {
      display: inline-block;
      background: #f1f5f9;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px;
      margin: 1em 0;
      text-align: center;
    }
    .tiptap-editor .youtube-embed:hover {
      border-color: #059669;
    }
    .tiptap-editor .youtube-embed img {
      margin: 0;
      border-radius: 8px;
    }
    .tiptap-toolbar button[title="YouTube Video"] {
      background: #FF0000;
      color: white;
      border-color: #FF0000;
    }
    .tiptap-toolbar button[title="YouTube Video"]:hover {
      background: #CC0000;
      border-color: #CC0000;
    }
  </style>
</head>
<body>
  <!-- Decap CMS Script -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <!-- Tiptap Editor Dependencies -->
  <script type="module">
    // Import Tiptap modules with pinned versions to avoid ProseMirror conflicts
    import { Editor } from 'https://cdn.jsdelivr.net/npm/@tiptap/core@2.2.4/+esm';
    import StarterKit from 'https://cdn.jsdelivr.net/npm/@tiptap/starter-kit@2.2.4/+esm';
    import Link from 'https://cdn.jsdelivr.net/npm/@tiptap/extension-link@2.2.4/+esm';
    import Image from 'https://cdn.jsdelivr.net/npm/@tiptap/extension-image@2.2.4/+esm';
    import Placeholder from 'https://cdn.jsdelivr.net/npm/@tiptap/extension-placeholder@2.2.4/+esm';
    import Underline from 'https://cdn.jsdelivr.net/npm/@tiptap/extension-underline@2.2.4/+esm';
    import TextAlign from 'https://cdn.jsdelivr.net/npm/@tiptap/extension-text-align@2.2.4/+esm';

    // Store Tiptap on window for the widget to access
    window.TiptapEditor = Editor;
    window.TiptapExtensions = { StarterKit, Link, Image, Placeholder, Underline, TextAlign };
    window.tiptapLoaded = true;

    // Dispatch event to notify CMS that Tiptap is ready
    window.dispatchEvent(new Event('tiptap-ready'));
  </script>

  {% raw %}
  <script>
    // Wait for Tiptap to load, then register the widget
    function registerTiptapWidget() {
      if (!window.tiptapLoaded) {
        window.addEventListener('tiptap-ready', registerTiptapWidget, { once: true });
        return;
      }

      var TiptapControl = createClass({
        getInitialState: function() {
          return { editor: null, ready: false };
        },

        componentDidMount: function() {
          this.initEditor();
        },

        componentWillUnmount: function() {
          if (this.state.editor) {
            this.state.editor.destroy();
          }
        },

        initEditor: function() {
          var self = this;
          var editorElement = this.editorRef;
          if (!editorElement || !window.TiptapEditor) return;

          var ext = window.TiptapExtensions;
          var initialContent = this.props.value || '';

          // Convert markdown to HTML for initial content
          var htmlContent = this.markdownToHtml(initialContent);

          var editor = new window.TiptapEditor({
            element: editorElement,
            extensions: [
              ext.StarterKit.configure({
                heading: { levels: [1, 2, 3] }
              }),
              ext.Link.configure({ openOnClick: false }),
              ext.Image,
              ext.Underline,
              ext.TextAlign.configure({ types: ['heading', 'paragraph'] }),
              ext.Placeholder.configure({ placeholder: 'Start writing your content...' })
            ],
            content: htmlContent,
            onUpdate: function(ctx) {
              var html = ctx.editor.getHTML();
              var markdown = self.htmlToMarkdown(html);
              self.props.onChange(markdown);
            }
          });

          this.setState({ editor: editor, ready: true });
        },

        // Simple markdown to HTML conversion
        markdownToHtml: function(md) {
          if (!md) return '<p></p>';
          var html = md
            // Convert YouTube shortcode to visual placeholder
            .replace(/\{% youtube "([^"]+)" %\}/gim, '<div class="youtube-embed" data-video-id="$1"><img src="https://img.youtube.com/vi/$1/mqdefault.jpg" alt="YouTube Video: $1" style="max-width:320px;border-radius:8px;cursor:pointer;"><span style="display:block;font-size:12px;color:#666;margin-top:4px;">â–¶ YouTube: $1</span></div>')
            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
            .replace(/\*\*\*(.*?)\*\*\*/gim, '<strong><em>$1</em></strong>')
            .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/gim, '<em>$1</em>')
            .replace(/__(.*?)__/gim, '<u>$1</u>')
            .replace(/~~(.*?)~~/gim, '<s>$1</s>')
            .replace(/`([^`]+)`/gim, '<code>$1</code>')
            .replace(/^\> (.*$)/gim, '<blockquote>$1</blockquote>')
            .replace(/^\- (.*$)/gim, '<li>$1</li>')
            .replace(/^\* (.*$)/gim, '<li>$1</li>')
            .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
            .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2">$1</a>')
            .replace(/!\[([^\]]*)\]\(([^)]+)\)/gim, '<img src="$2" alt="$1">')
            .replace(/^---$/gim, '<hr>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>');

          // Wrap in paragraphs if not already wrapped
          if (!html.startsWith('<')) {
            html = '<p>' + html + '</p>';
          }
          return html;
        },

        // Simple HTML to markdown conversion
        htmlToMarkdown: function(html) {
          if (!html) return '';
          var md = html
            // Convert YouTube visual placeholder back to shortcode
            .replace(/<div class="youtube-embed" data-video-id="([^"]+)"[^>]*>.*?<\/div>/gi, '{% youtube "$1" %}\n\n')
            // Also handle raw shortcode that might be in a paragraph
            .replace(/<p>\s*(\{% youtube "[^"]+" %\})\s*<\/p>/gi, '$1\n\n')
            .replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n')
            .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n')
            .replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n')
            .replace(/<strong><em>(.*?)<\/em><\/strong>/gi, '***$1***')
            .replace(/<em><strong>(.*?)<\/strong><\/em>/gi, '***$1***')
            .replace(/<strong>(.*?)<\/strong>/gi, '**$1**')
            .replace(/<b>(.*?)<\/b>/gi, '**$1**')
            .replace(/<em>(.*?)<\/em>/gi, '*$1*')
            .replace(/<i>(.*?)<\/i>/gi, '*$1*')
            .replace(/<u>(.*?)<\/u>/gi, '__$1__')
            .replace(/<s>(.*?)<\/s>/gi, '~~$1~~')
            .replace(/<code>(.*?)<\/code>/gi, '`$1`')
            .replace(/<blockquote[^>]*>(.*?)<\/blockquote>/gi, '> $1\n\n')
            .replace(/<li>(.*?)<\/li>/gi, '- $1\n')
            .replace(/<ul[^>]*>|<\/ul>/gi, '\n')
            .replace(/<ol[^>]*>|<\/ol>/gi, '\n')
            .replace(/<a href="([^"]+)"[^>]*>(.*?)<\/a>/gi, '[$2]($1)')
            // Skip YouTube thumbnail images
            .replace(/<img[^>]*src="https:\/\/img\.youtube\.com[^"]*"[^>]*\/?>/gi, '')
            .replace(/<img[^>]*src="([^"]+)"[^>]*alt="([^"]*)"[^>]*\/?>/gi, '![$2]($1)')
            .replace(/<img[^>]*src="([^"]+)"[^>]*\/?>/gi, '![]($1)')
            .replace(/<hr\s*\/?>/gi, '\n---\n')
            .replace(/<br\s*\/?>/gi, '\n')
            .replace(/<p[^>]*>/gi, '')
            .replace(/<\/p>/gi, '\n\n')
            // Remove span tags (used in YouTube placeholder)
            .replace(/<span[^>]*>.*?<\/span>/gi, '')
            .replace(/<[^>]+>/g, '')
            .replace(/&nbsp;/g, ' ')
            .replace(/&amp;/g, '&')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/\n{3,}/g, '\n\n')
            .trim();
          return md;
        },

        execCommand: function(cmd, value) {
          var editor = this.state.editor;
          if (!editor) return;

          switch(cmd) {
            case 'bold': editor.chain().focus().toggleBold().run(); break;
            case 'italic': editor.chain().focus().toggleItalic().run(); break;
            case 'underline': editor.chain().focus().toggleUnderline().run(); break;
            case 'strike': editor.chain().focus().toggleStrike().run(); break;
            case 'h1': editor.chain().focus().toggleHeading({ level: 1 }).run(); break;
            case 'h2': editor.chain().focus().toggleHeading({ level: 2 }).run(); break;
            case 'h3': editor.chain().focus().toggleHeading({ level: 3 }).run(); break;
            case 'bulletList': editor.chain().focus().toggleBulletList().run(); break;
            case 'orderedList': editor.chain().focus().toggleOrderedList().run(); break;
            case 'blockquote': editor.chain().focus().toggleBlockquote().run(); break;
            case 'code': editor.chain().focus().toggleCode().run(); break;
            case 'codeBlock': editor.chain().focus().toggleCodeBlock().run(); break;
            case 'hr': editor.chain().focus().setHorizontalRule().run(); break;
            case 'alignLeft': editor.chain().focus().setTextAlign('left').run(); break;
            case 'alignCenter': editor.chain().focus().setTextAlign('center').run(); break;
            case 'alignRight': editor.chain().focus().setTextAlign('right').run(); break;
            case 'link':
              var url = prompt('Enter URL:');
              if (url) editor.chain().focus().setLink({ href: url }).run();
              break;
            case 'unlink': editor.chain().focus().unsetLink().run(); break;
            case 'image':
              var imgUrl = prompt('Enter image URL:');
              if (imgUrl) editor.chain().focus().setImage({ src: imgUrl }).run();
              break;
            case 'youtube':
              var ytInput = prompt('Enter YouTube URL or Video ID:');
              if (ytInput) {
                var videoId = ytInput;
                // Extract video ID from various YouTube URL formats
                if (ytInput.includes('v=')) {
                  videoId = ytInput.split('v=')[1].split('&')[0];
                } else if (ytInput.includes('youtu.be/')) {
                  videoId = ytInput.split('youtu.be/')[1].split('?')[0];
                } else if (ytInput.includes('youtube.com/embed/')) {
                  videoId = ytInput.split('youtube.com/embed/')[1].split('?')[0];
                }
                // Insert YouTube shortcode as a paragraph
                var shortcode = '{% youtube "' + videoId + '" %}';
                editor.chain().focus().insertContent('<p>' + shortcode + '</p>').run();
              }
              break;
            case 'undo': editor.chain().focus().undo().run(); break;
            case 'redo': editor.chain().focus().redo().run(); break;
          }
          this.forceUpdate();
        },

        isActive: function(cmd, attrs) {
          var editor = this.state.editor;
          if (!editor) return false;

          switch(cmd) {
            case 'bold': return editor.isActive('bold');
            case 'italic': return editor.isActive('italic');
            case 'underline': return editor.isActive('underline');
            case 'strike': return editor.isActive('strike');
            case 'h1': return editor.isActive('heading', { level: 1 });
            case 'h2': return editor.isActive('heading', { level: 2 });
            case 'h3': return editor.isActive('heading', { level: 3 });
            case 'bulletList': return editor.isActive('bulletList');
            case 'orderedList': return editor.isActive('orderedList');
            case 'blockquote': return editor.isActive('blockquote');
            case 'code': return editor.isActive('code');
            case 'codeBlock': return editor.isActive('codeBlock');
            case 'link': return editor.isActive('link');
            case 'alignLeft': return editor.isActive({ textAlign: 'left' });
            case 'alignCenter': return editor.isActive({ textAlign: 'center' });
            case 'alignRight': return editor.isActive({ textAlign: 'right' });
            default: return false;
          }
        },

        render: function() {
          var self = this;
          var toolbarButtons = [
            { cmd: 'bold', label: 'B', title: 'Bold' },
            { cmd: 'italic', label: 'I', title: 'Italic' },
            { cmd: 'underline', label: 'U', title: 'Underline' },
            { cmd: 'strike', label: 'S', title: 'Strikethrough' },
            { type: 'separator' },
            { cmd: 'h1', label: 'H1', title: 'Heading 1' },
            { cmd: 'h2', label: 'H2', title: 'Heading 2' },
            { cmd: 'h3', label: 'H3', title: 'Heading 3' },
            { type: 'separator' },
            { cmd: 'bulletList', label: 'â€¢', title: 'Bullet List' },
            { cmd: 'orderedList', label: '1.', title: 'Numbered List' },
            { cmd: 'blockquote', label: '"', title: 'Quote' },
            { type: 'separator' },
            { cmd: 'alignLeft', label: 'â¬…', title: 'Align Left' },
            { cmd: 'alignCenter', label: 'â¬Œ', title: 'Align Center' },
            { cmd: 'alignRight', label: 'âž¡', title: 'Align Right' },
            { type: 'separator' },
            { cmd: 'link', label: 'ðŸ”—', title: 'Link' },
            { cmd: 'image', label: 'ðŸ–¼', title: 'Image' },
            { cmd: 'youtube', label: 'â–¶', title: 'YouTube Video' },
            { cmd: 'code', label: '</>', title: 'Inline Code' },
            { cmd: 'hr', label: 'â€•', title: 'Horizontal Rule' },
            { type: 'separator' },
            { cmd: 'undo', label: 'â†©', title: 'Undo' },
            { cmd: 'redo', label: 'â†ª', title: 'Redo' }
          ];

          return h('div', { className: 'tiptap-wrapper' },
            h('div', { className: 'tiptap-toolbar' },
              toolbarButtons.map(function(btn, idx) {
                if (btn.type === 'separator') {
                  return h('div', { key: idx, className: 'separator' });
                }
                return h('button', {
                  key: idx,
                  type: 'button',
                  title: btn.title,
                  className: self.isActive(btn.cmd) ? 'is-active' : '',
                  onClick: function(e) { e.preventDefault(); self.execCommand(btn.cmd); }
                }, btn.label);
              })
            ),
            h('div', {
              className: 'tiptap-editor',
              ref: function(el) { self.editorRef = el; }
            })
          );
        }
      });

      // Register the Tiptap widget
      CMS.registerWidget('tiptap', TiptapControl);
      console.log('[Tiptap] Widget registered successfully');
    }

    // Initialize registration
    registerTiptapWidget();

    // Register preview styles - order matters, preview.css last to override
    CMS.registerPreviewStyle("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap");
    CMS.registerPreviewStyle("/admin/preview.css");

    // Custom preview template for blog posts
    var BlogPreview = createClass({
      render: function() {
        var entry = this.props.entry;
        var title = entry.getIn(['data', 'title']) || 'Untitled';
        var body = this.props.widgetFor('body');
        var image = entry.getIn(['data', 'image']);
        var date = entry.getIn(['data', 'date']);
        var description = entry.getIn(['data', 'description']);
        var formattedDate = '';

        if (date) {
          try {
            formattedDate = new Date(date).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
          } catch(e) {
            formattedDate = date;
          }
        }

        return h('div', { className: 'preview-container' },
          h('article', {},
            image && h('img', { src: image, alt: title }),
            h('h1', {}, title),
            formattedDate && h('p', { style: { color: '#64748b', fontSize: '0.9rem' } }, formattedDate),
            description && h('p', { style: { fontSize: '1.2rem', fontStyle: 'italic', color: '#475569', marginBottom: '2rem' } }, description),
            h('div', { className: 'blog-content' }, body)
          )
        );
      }
    });

    CMS.registerPreviewTemplate('blog', BlogPreview);

    // Register YouTube editor component
    CMS.registerEditorComponent({
      id: "youtube",
      label: "YouTube",
      fields: [{name: 'id', label: 'YouTube Video ID or URL', widget: 'string'}],
      pattern: /^{% youtube "([^"]+)" %}$/,
      fromBlock: function(match) {
        return { id: match[1] };
      },
      toBlock: function(obj) {
        var id = obj.id || '';
        if (id.includes('v=')) {
          id = id.split('v=')[1].split('&')[0];
        } else if (id.includes('youtu.be/')) {
          id = id.split('youtu.be/')[1].split('?')[0];
        }
        return '{% youtube "' + id + '" %}';
      },
      toPreview: function(obj) {
        return '<img src="https://img.youtube.com/vi/' + obj.id + '/0.jpg" alt="YouTube Video" />';
      }
    });

    // Auto SEO Generation System
    (function() {
      var debounceTimer = null;
      var lastContent = '';
      var hasGenerated = false;
      var isGenerating = false;

      function showStatus(message, isError) {
        console.log('[AI SEO]', message);
        var existing = document.getElementById('ai-status-toast');
        if (existing) existing.remove();

        var toast = document.createElement('div');
        toast.id = 'ai-status-toast';
        toast.style.cssText = 'position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:8px;font-size:14px;font-weight:500;z-index:10000;transition:opacity 0.3s;' +
          (isError ? 'background:#EF4444;color:white;' : 'background:#10B981;color:white;');
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(function() { toast.style.opacity = '0'; }, 3000);
        setTimeout(function() { toast.remove(); }, 3500);
      }

      function findField(fieldName) {
        // Try multiple selector strategies for Decap CMS fields
        var selectors = [
          'input[id*="' + fieldName + '"]',
          'textarea[id*="' + fieldName + '"]',
          'input[id*="' + fieldName.toLowerCase() + '"]',
          'textarea[id*="' + fieldName.toLowerCase() + '"]',
          '[data-field-name="' + fieldName + '"] input',
          '[data-field-name="' + fieldName + '"] textarea'
        ];

        for (var i = 0; i < selectors.length; i++) {
          var el = document.querySelector(selectors[i]);
          if (el) return el;
        }

        // Handle nested field names like 'twitter-text' or 'linkedin-hashtags'
        if (fieldName.includes('-')) {
          var parts = fieldName.split('-');
          var parentName = parts[0]; // e.g., 'twitter', 'facebook'
          var childName = parts[1];  // e.g., 'text', 'hashtags'

          // Find the parent section first
          var parentLabels = {
            'twitter': 'twitter',
            'facebook': 'facebook',
            'linkedin': 'linkedin',
            'instagram': 'instagram'
          };

          var childLabels = {
            'text': ['tweet text', 'post text', 'caption'],
            'hashtags': ['hashtags']
          };

          // Find all collapsible sections
          var sections = document.querySelectorAll('[class*="ObjectControl"], [class*="ObjectWidget"]');
          for (var s = 0; s < sections.length; s++) {
            var sectionText = sections[s].textContent.toLowerCase();
            // Check if this section contains the parent name (e.g., "twitter/x post")
            if (sectionText.includes(parentLabels[parentName])) {
              // Now find the child field within this section
              var childTerms = childLabels[childName] || [childName];
              var labels = sections[s].querySelectorAll('label');
              for (var l = 0; l < labels.length; l++) {
                var labelText = labels[l].textContent.toLowerCase().trim();
                for (var t = 0; t < childTerms.length; t++) {
                  if (labelText === childTerms[t] || labelText.includes(childTerms[t])) {
                    var container = labels[l].closest('[class*="ControlContainer"], [class*="Field"]');
                    if (container) {
                      var input = container.querySelector('input, textarea');
                      if (input) return input;
                    }
                  }
                }
              }
            }
          }
        }

        // Try finding by label text for simple fields
        var labels = document.querySelectorAll('label');
        for (var j = 0; j < labels.length; j++) {
          var labelText = labels[j].textContent.toLowerCase();
          var searchTerms = {
            'socialCaption': ['draft tweet', 'caption'],
            'metaTitle': ['meta title'],
            'metaDesc': ['meta description'],
            'keywords': ['keywords'],
            'description': ['excerpt']
          };

          var terms = searchTerms[fieldName] || [fieldName.toLowerCase()];
          for (var k = 0; k < terms.length; k++) {
            if (labelText.includes(terms[k])) {
              var container = labels[j].closest('[class*="ControlContainer"], [class*="Field"]');
              if (container) {
                var input = container.querySelector('input, textarea');
                if (input) return input;
              }
            }
          }
        }

        return null;
      }

      function getFieldValue(fieldName) {
        var el = findField(fieldName);
        return el ? el.value : '';
      }

      function isFieldEmpty(fieldName) {
        return !getFieldValue(fieldName);
      }

      function setFieldValue(fieldName, value) {
        var el = findField(fieldName);
        if (el) {
          el.value = value;
          el.dispatchEvent(new Event('input', { bubbles: true }));
          el.dispatchEvent(new Event('change', { bubbles: true }));
          return true;
        }
        console.log('[AI SEO] Could not find field:', fieldName);
        return false;
      }

      function getEditorContent() {
        var editor = document.querySelector('[data-slate-editor="true"]');
        if (editor) return editor.textContent || '';
        var cm = document.querySelector('.CodeMirror');
        if (cm && cm.CodeMirror) return cm.CodeMirror.getValue() || '';
        var ce = document.querySelector('[contenteditable="true"]');
        if (ce) return ce.textContent || '';
        return '';
      }

      async function generateSEO(isManual) {
        if (isGenerating) return;

        var title = getFieldValue('title');
        var body = getEditorContent();

        if (!title || title.length < 10) {
          if (isManual) showStatus('Title too short (min 10 chars)', true);
          return;
        }
        if (!body || body.length < 50) {
          if (isManual) showStatus('Content too short (min 50 chars)', true);
          return;
        }

        // Skip if all fields already filled (unless manual)
        var allFilled = !isFieldEmpty('keywords') && !isFieldEmpty('metaTitle') && !isFieldEmpty('metaDesc');
        if (allFilled && !isManual) return;

        isGenerating = true;
        showStatus('Generating SEO content...');

        try {
          var response = await fetch('/.netlify/functions/generate-seo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: title, body: body })
          });

          if (!response.ok) throw new Error('API error');
          var data = await response.json();
          if (data.error) throw new Error(data.error);

          // Only fill empty fields (unless manual regenerate)
          var filled = [];
          if ((isFieldEmpty('keywords') || isManual) && data.keywords) {
            setFieldValue('keywords', data.keywords.join(', '));
            filled.push('keywords');
          }
          if ((isFieldEmpty('metaTitle') || isManual) && data.metaTitle) {
            setFieldValue('metaTitle', data.metaTitle);
            filled.push('meta title');
          }
          if ((isFieldEmpty('metaDesc') || isManual) && data.metaDesc) {
            setFieldValue('metaDesc', data.metaDesc);
            filled.push('meta desc');
          }
          if ((isFieldEmpty('description') || isManual) && data.excerpt) {
            setFieldValue('description', data.excerpt);
            filled.push('excerpt');
          }
          if ((isFieldEmpty('socialCaption') || isManual) && data.socialCaption) {
            setFieldValue('socialCaption', data.socialCaption);
            filled.push('social caption');
          }

          // Fill social media platform fields
          if (data.twitter) {
            if ((isFieldEmpty('twitter-text') || isManual) && data.twitter.text) {
              setFieldValue('twitter-text', data.twitter.text);
              filled.push('twitter');
            }
            if ((isFieldEmpty('twitter-hashtags') || isManual) && data.twitter.hashtags) {
              setFieldValue('twitter-hashtags', data.twitter.hashtags);
            }
          }
          if (data.facebook) {
            if ((isFieldEmpty('facebook-text') || isManual) && data.facebook.text) {
              setFieldValue('facebook-text', data.facebook.text);
              filled.push('facebook');
            }
          }
          if (data.linkedin) {
            if ((isFieldEmpty('linkedin-text') || isManual) && data.linkedin.text) {
              setFieldValue('linkedin-text', data.linkedin.text);
              filled.push('linkedin');
            }
            if ((isFieldEmpty('linkedin-hashtags') || isManual) && data.linkedin.hashtags) {
              setFieldValue('linkedin-hashtags', data.linkedin.hashtags);
            }
          }
          if (data.instagram) {
            if ((isFieldEmpty('instagram-text') || isManual) && data.instagram.text) {
              setFieldValue('instagram-text', data.instagram.text);
              filled.push('instagram');
            }
            if ((isFieldEmpty('instagram-hashtags') || isManual) && data.instagram.hashtags) {
              setFieldValue('instagram-hashtags', data.instagram.hashtags);
            }
          }

          if (filled.length > 0) {
            showStatus('Generated: ' + filled.join(', '));
            hasGenerated = true;
          } else {
            showStatus('All fields already filled');
          }

          console.log('[AI SEO] Full response:', data);

        } catch (err) {
          console.error('[AI SEO] Error:', err);
          showStatus('Generation failed: ' + err.message, true);
        } finally {
          isGenerating = false;
        }
      }

      function checkForChanges() {
        var title = getFieldValue('title');
        var body = getEditorContent();
        var content = title + '|||' + body;

        if (content !== lastContent && title && body) {
          lastContent = content;
          clearTimeout(debounceTimer);
          // Auto-generate 3 seconds after user stops typing
          debounceTimer = setTimeout(function() {
            generateSEO(false);
          }, 3000);
        }
      }

      function addManualButton() {
        if (document.getElementById('ai-generate-btn')) return;

        var btn = document.createElement('button');
        btn.id = 'ai-generate-btn';
        btn.innerHTML = 'âœ¨ Regenerate SEO';
        btn.style.cssText = 'position:fixed;bottom:24px;right:24px;padding:12px 20px;background:linear-gradient(135deg,#8B5CF6,#6366F1);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;z-index:9999;box-shadow:0 4px 12px rgba(139,92,246,0.4);';
        btn.onclick = function() { generateSEO(true); };
        document.body.appendChild(btn);
      }

      function removeButton() {
        var btn = document.getElementById('ai-generate-btn');
        if (btn) btn.remove();
      }

      function checkEditor() {
        var url = window.location.href;
        var isBlogEditor = url.includes('/collections/blog/') || url.includes('collection=blog');

        if (isBlogEditor) {
          addManualButton();
          checkForChanges();
        } else {
          removeButton();
          hasGenerated = false;
          lastContent = '';
        }
      }

      setInterval(checkEditor, 1000);
    })();
  </script>
  {% endraw %}
</body>
</html>
