<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <!-- Identity Widget for Netlify Auth -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <link rel="config" type="text/yaml" href="/admin/config.yml" />
  <style>
    /* Custom Login Page Styling */
    #nc-root div[class*="nc-login-logo"] {
      background-image: url('/public/images/icon/robspain-icon.png') !important;
      background-size: contain !important;
      background-repeat: no-repeat !important;
      background-position: center !important;
      width: 120px !important;
      height: 120px !important;
      margin-bottom: 0 !important;
    }
    #nc-root div[class*="nc-login-logo"] svg {
      display: none !important;
    }
    #nc-root div[class*="nc-login-container"]::before {
      content: 'robspain.com';
      display: block;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 2.5rem;
      font-weight: 800;
      color: #059669;
      margin-bottom: 2rem;
      text-align: center;
      letter-spacing: -0.05em;
    }
    #nc-root div[class*="nc-login-container"] {
      background-color: #f8fafc !important;
    }
    #nc-root button[class*="nc-login-button"] {
      background-color: #059669 !important;
      color: white !important;
      border-radius: 12px !important;
      padding: 12px 24px !important;
      font-weight: 600 !important;
      transition: all 0.3s ease !important;
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2) !important;
    }
    #nc-root button[class*="nc-login-button"]:hover {
      background-color: #047857 !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 8px 20px rgba(5, 150, 105, 0.3) !important;
    }

    /* AI Generation Button Styles */
    .ai-generate-btn {
      background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
      margin-bottom: 8px;
    }
    .ai-generate-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }
    .ai-generate-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
    .ai-generate-btn .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .ai-button-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .ai-generate-all {
      padding: 12px 20px;
      font-size: 14px;
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
    }
    .ai-generate-image {
      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
      padding: 12px 20px;
      font-size: 14px;
      box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4);
    }
    .ai-generate-image:hover {
      box-shadow: 0 4px 20px rgba(245, 158, 11, 0.6);
    }
    .ai-image-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .ai-image-modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
    }
    .ai-image-modal h3 {
      margin: 0 0 16px 0;
      font-size: 1.25rem;
      color: #1e293b;
    }
    .ai-image-modal img {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .ai-image-modal-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .ai-image-modal button {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .ai-image-modal .btn-primary {
      background: #10B981;
      color: white;
    }
    .ai-image-modal .btn-secondary {
      background: #E2E8F0;
      color: #475569;
    }
    .ai-image-modal .btn-close {
      background: #EF4444;
      color: white;
    }
    .ai-toast {
      position: fixed;
      bottom: 140px;
      right: 24px;
      background: #10B981;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 10000;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .ai-toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    .ai-toast.error {
      background: #EF4444;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
  </style>
</head>
<body>
  <!-- Decap CMS Script -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  {% raw %}
  <script>
    // Register preview styles
    CMS.registerPreviewStyle("/premium-styles.css");
    CMS.registerPreviewStyle("/premium-responsive.css");
    CMS.registerPreviewStyle("/styles.css");

    // Register YouTube editor component
    CMS.registerEditorComponent({
      id: "youtube",
      label: "YouTube",
      fields: [{name: 'id', label: 'YouTube Video ID or URL', widget: 'string'}],
      pattern: /^{% youtube "([^"]+)" %}$/,
      fromBlock: function(match) {
        return { id: match[1] };
      },
      toBlock: function(obj) {
        var id = obj.id || '';
        if (id.includes('v=')) {
          id = id.split('v=')[1].split('&')[0];
        } else if (id.includes('youtu.be/')) {
          id = id.split('youtu.be/')[1].split('?')[0];
        }
        return '{% youtube "' + id + '" %}';
      },
      toPreview: function(obj) {
        return '<img src="https://img.youtube.com/vi/' + obj.id + '/0.jpg" alt="YouTube Video" />';
      }
    });

    // AI SEO & Image Generation System
    (function() {
      var buttonContainer = null;
      var seoButton = null;
      var imageButton = null;
      var toast = null;
      var isGenerating = false;
      var isGeneratingImage = false;

      function showToast(message, isError) {
        if (!toast) {
          toast = document.createElement('div');
          toast.className = 'ai-toast';
          document.body.appendChild(toast);
        }
        toast.textContent = message;
        toast.className = 'ai-toast' + (isError ? ' error' : '');
        setTimeout(function() { toast.classList.add('show'); }, 10);
        setTimeout(function() { toast.classList.remove('show'); }, 4000);
      }

      function getFieldValue(fieldName) {
        var input = document.querySelector('[id*="' + fieldName + '"] input, [id*="' + fieldName + '"] textarea');
        if (input) return input.value;

        var field = document.querySelector('[data-field-name="' + fieldName + '"] input, [data-field-name="' + fieldName + '"] textarea');
        if (field) return field.value;

        return '';
      }

      function setFieldValue(fieldName, value, isArray) {
        if (isArray && Array.isArray(value)) {
          var containers = document.querySelectorAll('[class*="ListControl"]');
          containers.forEach(function(container) {
            var label = container.closest('[class*="ControlContainer"]');
            if (label && label.textContent.toLowerCase().includes(fieldName.toLowerCase())) {
              var input = container.querySelector('input');
              if (input) {
                value.forEach(function(item, index) {
                  if (index === 0) {
                    input.value = item;
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                  }
                });
              }
            }
          });
          return;
        }

        var selectors = [
          '[id*="' + fieldName + '"] input',
          '[id*="' + fieldName + '"] textarea',
          '[data-field-name="' + fieldName + '"] input',
          '[data-field-name="' + fieldName + '"] textarea',
          'input[name*="' + fieldName + '"]',
          'textarea[name*="' + fieldName + '"]'
        ];

        for (var i = 0; i < selectors.length; i++) {
          var input = document.querySelector(selectors[i]);
          if (input) {
            input.value = value;
            input.dispatchEvent(new Event('input', { bubbles: true }));
            input.dispatchEvent(new Event('change', { bubbles: true }));
            return;
          }
        }
      }

      function getEditorContent() {
        var cm = document.querySelector('.CodeMirror');
        if (cm && cm.CodeMirror) {
          return cm.CodeMirror.getValue();
        }

        var editor = document.querySelector('[data-slate-editor="true"]');
        if (editor) {
          return editor.textContent;
        }

        var contentEditable = document.querySelector('[contenteditable="true"]');
        if (contentEditable) {
          return contentEditable.textContent;
        }

        var textarea = document.querySelector('.cms-editor textarea, [class*="body"] textarea');
        if (textarea) {
          return textarea.value;
        }

        return '';
      }

      async function generateAIContent() {
        if (isGenerating) return;

        var title = getFieldValue('title');
        var body = getEditorContent();

        if (!title) {
          showToast('Please enter a title first', true);
          return;
        }

        isGenerating = true;
        if (seoButton) {
          seoButton.innerHTML = '<span class="spinner"></span> Generating...';
          seoButton.disabled = true;
        }

        try {
          var response = await fetch('/.netlify/functions/generate-seo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: title, body: body })
          });

          if (!response.ok) throw new Error('API request failed');

          var data = await response.json();
          if (data.error) throw new Error(data.error);

          if (data.tags) setFieldValue('tags', data.tags, true);
          if (data.keywords) setFieldValue('keywords', data.keywords, true);
          if (data.metaTitle) setFieldValue('metaTitle', data.metaTitle);
          if (data.metaDesc) setFieldValue('metaDesc', data.metaDesc);
          if (data.excerpt) setFieldValue('description', data.excerpt);
          if (data.socialCaption) setFieldValue('socialCaption', data.socialCaption);

          showToast('SEO content generated! Check console for full data.');
          console.log('AI Generated Content:', data);

        } catch (err) {
          console.error('AI Generation failed:', err);
          showToast('Generation failed: ' + err.message, true);
        } finally {
          isGenerating = false;
          if (seoButton) {
            seoButton.innerHTML = 'âœ¨ Generate SEO';
            seoButton.disabled = false;
          }
        }
      }

      async function generateAIImage() {
        if (isGeneratingImage) return;

        var title = getFieldValue('title');
        var body = getEditorContent();

        if (!title) {
          showToast('Please enter a title first', true);
          return;
        }

        isGeneratingImage = true;
        if (imageButton) {
          imageButton.innerHTML = '<span class="spinner"></span> Creating image...';
          imageButton.disabled = true;
        }

        showToast('Generating image... this may take 15-30 seconds');

        try {
          var response = await fetch('/.netlify/functions/generate-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: title, body: body, keywords: [] })
          });

          if (!response.ok) throw new Error('Image generation failed');

          var data = await response.json();
          if (data.error) throw new Error(data.error);

          // Create blob from base64
          var byteCharacters = atob(data.base64);
          var byteNumbers = new Array(byteCharacters.length);
          for (var i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          var byteArray = new Uint8Array(byteNumbers);
          var blob = new Blob([byteArray], { type: 'image/png' });
          var blobUrl = URL.createObjectURL(blob);

          // Show modal with the image
          showImageModal(blobUrl, data.filename || 'featured-image.png', blob);

        } catch (err) {
          console.error('Image generation failed:', err);
          showToast('Image generation failed: ' + err.message, true);
        } finally {
          isGeneratingImage = false;
          if (imageButton) {
            imageButton.innerHTML = 'ðŸŽ¨ Generate Image';
            imageButton.disabled = false;
          }
        }
      }

      function showImageModal(blobUrl, filename, blob) {
        var modal = document.createElement('div');
        modal.className = 'ai-image-modal';
        modal.innerHTML = '<div class="ai-image-modal-content">' +
          '<h3>AI Generated Featured Image</h3>' +
          '<img src="' + blobUrl + '" alt="Generated image" />' +
          '<p style="color:#64748b;font-size:13px;margin-bottom:16px;">Right-click the image to copy or save it, then use "Choose different image" or "Replace with URL" in the CMS to upload it.</p>' +
          '<div class="ai-image-modal-actions">' +
            '<button class="btn-primary" id="ai-download-btn">Download Image</button>' +
            '<button class="btn-secondary" id="ai-copy-btn">Copy to Clipboard</button>' +
            '<button class="btn-close" id="ai-close-btn">Close</button>' +
          '</div>' +
        '</div>';

        document.body.appendChild(modal);

        document.getElementById('ai-download-btn').onclick = function() {
          var a = document.createElement('a');
          a.href = blobUrl;
          a.download = filename;
          a.click();
          showToast('Image downloaded!');
        };

        document.getElementById('ai-copy-btn').onclick = async function() {
          try {
            await navigator.clipboard.write([
              new ClipboardItem({ 'image/png': blob })
            ]);
            showToast('Image copied to clipboard!');
          } catch (e) {
            showToast('Could not copy - try right-click instead', true);
          }
        };

        document.getElementById('ai-close-btn').onclick = function() {
          modal.remove();
          URL.revokeObjectURL(blobUrl);
        };

        modal.onclick = function(e) {
          if (e.target === modal) {
            modal.remove();
            URL.revokeObjectURL(blobUrl);
          }
        };
      }

      function createButtons() {
        if (buttonContainer && document.body.contains(buttonContainer)) return;

        buttonContainer = document.createElement('div');
        buttonContainer.className = 'ai-button-container';

        seoButton = document.createElement('button');
        seoButton.className = 'ai-generate-btn ai-generate-all';
        seoButton.innerHTML = 'âœ¨ Generate SEO';
        seoButton.onclick = generateAIContent;

        imageButton = document.createElement('button');
        imageButton.className = 'ai-generate-btn ai-generate-image';
        imageButton.innerHTML = 'ðŸŽ¨ Generate Image';
        imageButton.onclick = generateAIImage;

        buttonContainer.appendChild(seoButton);
        buttonContainer.appendChild(imageButton);
        document.body.appendChild(buttonContainer);
      }

      function removeButtons() {
        if (buttonContainer && buttonContainer.parentNode) {
          buttonContainer.parentNode.removeChild(buttonContainer);
          buttonContainer = null;
          seoButton = null;
          imageButton = null;
        }
      }

      function checkForBlogEditor() {
        var url = window.location.href;
        var isBlogEditor = url.includes('/collections/blog/') ||
                          url.includes('collection=blog') ||
                          (url.includes('/entries/') && document.querySelector('[class*="EditorControlPane"]'));

        if (isBlogEditor) {
          createButtons();
        } else {
          removeButtons();
        }
      }

      setTimeout(checkForBlogEditor, 1000);
      setInterval(checkForBlogEditor, 2000);

      window.addEventListener('hashchange', function() {
        setTimeout(checkForBlogEditor, 500);
      });
    })();
  </script>
  {% endraw %}
</body>
</html>