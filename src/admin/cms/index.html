<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <!-- Identity Widget for Netlify Auth -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    /* Custom Login Page Styling */
    #nc-root div[class*="nc-login-logo"] {
      background-image: url('/public/images/icon/robspain-icon.png') !important;
      background-size: contain !important;
      background-repeat: no-repeat !important;
      background-position: center !important;
      width: 120px !important;
      height: 120px !important;
      margin-bottom: 0 !important;
    }
    #nc-root div[class*="nc-login-logo"] svg {
      display: none !important;
    }
    #nc-root div[class*="nc-login-container"]::before {
      content: 'robspain.com';
      display: block;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 2.5rem;
      font-weight: 800;
      color: #059669;
      margin-bottom: 2rem;
      text-align: center;
      letter-spacing: -0.05em;
    }
    #nc-root div[class*="nc-login-container"] {
      background-color: #f8fafc !important;
    }
    #nc-root button[class*="nc-login-button"] {
      background-color: #059669 !important;
      color: white !important;
      border-radius: 12px !important;
      padding: 12px 24px !important;
      font-weight: 600 !important;
      transition: all 0.3s ease !important;
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2) !important;
    }
    #nc-root button[class*="nc-login-button"]:hover {
      background-color: #047857 !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 8px 20px rgba(5, 150, 105, 0.3) !important;
    }
  </style>
</head>
<body>
  <!-- Decap CMS Script -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  {% raw %}
  <script>
    // Register preview styles
    CMS.registerPreviewStyle("/premium-styles.css");
    CMS.registerPreviewStyle("/premium-responsive.css");
    CMS.registerPreviewStyle("/styles.css");
    CMS.registerPreviewStyle("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap");

    // Custom preview template for blog posts
    var BlogPreview = createClass({
      render: function() {
        var entry = this.props.entry;
        var title = entry.getIn(['data', 'title']) || 'Untitled';
        var body = this.props.widgetFor('body');
        var image = entry.getIn(['data', 'image']);
        var date = entry.getIn(['data', 'date']);
        var description = entry.getIn(['data', 'description']);

        return h('div', { className: 'preview-container', style: {
          fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif',
          maxWidth: '800px',
          margin: '0 auto',
          padding: '2rem',
          lineHeight: '1.7',
          color: '#1e293b'
        }},
          h('article', { className: 'blog-post' },
            image && h('img', {
              src: image,
              alt: title,
              style: {
                width: '100%',
                height: 'auto',
                borderRadius: '12px',
                marginBottom: '2rem'
              }
            }),
            h('h1', { style: {
              fontSize: '2.5rem',
              fontWeight: '800',
              marginBottom: '1rem',
              lineHeight: '1.2',
              color: '#0f172a'
            }}, title),
            date && h('p', { style: {
              color: '#64748b',
              fontSize: '0.9rem',
              marginBottom: '1rem'
            }}, new Date(date).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })),
            description && h('p', { style: {
              fontSize: '1.25rem',
              color: '#475569',
              marginBottom: '2rem',
              fontStyle: 'italic'
            }}, description),
            h('div', {
              className: 'blog-content',
              style: {
                fontSize: '1.1rem'
              }
            }, body)
          )
        );
      }
    });

    CMS.registerPreviewTemplate('blog', BlogPreview);

    // Add preview-specific styles
    CMS.registerPreviewStyle(`
      .blog-content h1, .blog-content h2, .blog-content h3, .blog-content h4 {
        margin-top: 2rem;
        margin-bottom: 1rem;
        font-weight: 700;
        line-height: 1.3;
        color: #0f172a;
      }
      .blog-content h2 {
        font-size: 1.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #10B981;
      }
      .blog-content h3 {
        font-size: 1.4rem;
      }
      .blog-content h4 {
        font-size: 1.2rem;
      }
      .blog-content p {
        margin-bottom: 1.25rem;
        color: #334155;
      }
      .blog-content ul, .blog-content ol {
        margin: 1.5rem 0;
        padding-left: 1.5rem;
      }
      .blog-content li {
        margin-bottom: 0.75rem;
        padding-left: 0.5rem;
      }
      .blog-content ul li {
        list-style-type: disc;
      }
      .blog-content ol li {
        list-style-type: decimal;
      }
      .blog-content strong {
        font-weight: 600;
        color: #0f172a;
      }
      .blog-content a {
        color: #10B981;
        text-decoration: underline;
      }
      .blog-content blockquote {
        border-left: 4px solid #10B981;
        padding-left: 1.5rem;
        margin: 1.5rem 0;
        font-style: italic;
        color: #475569;
      }
      .blog-content code {
        background: #f1f5f9;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-size: 0.9em;
      }
      .blog-content pre {
        background: #1e293b;
        color: #e2e8f0;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
        margin: 1.5rem 0;
      }
      .blog-content img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 1.5rem 0;
      }
    `, { raw: true });

    // Register YouTube editor component
    CMS.registerEditorComponent({
      id: "youtube",
      label: "YouTube",
      fields: [{name: 'id', label: 'YouTube Video ID or URL', widget: 'string'}],
      pattern: /^{% youtube "([^"]+)" %}$/,
      fromBlock: function(match) {
        return { id: match[1] };
      },
      toBlock: function(obj) {
        var id = obj.id || '';
        if (id.includes('v=')) {
          id = id.split('v=')[1].split('&')[0];
        } else if (id.includes('youtu.be/')) {
          id = id.split('youtu.be/')[1].split('?')[0];
        }
        return '{% youtube "' + id + '" %}';
      },
      toPreview: function(obj) {
        return '<img src="https://img.youtube.com/vi/' + obj.id + '/0.jpg" alt="YouTube Video" />';
      }
    });

    // Auto SEO Generation System
    (function() {
      var debounceTimer = null;
      var lastContent = '';
      var hasGenerated = false;
      var isGenerating = false;

      function showStatus(message, isError) {
        console.log('[AI SEO]', message);
        var existing = document.getElementById('ai-status-toast');
        if (existing) existing.remove();

        var toast = document.createElement('div');
        toast.id = 'ai-status-toast';
        toast.style.cssText = 'position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:8px;font-size:14px;font-weight:500;z-index:10000;transition:opacity 0.3s;' +
          (isError ? 'background:#EF4444;color:white;' : 'background:#10B981;color:white;');
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(function() { toast.style.opacity = '0'; }, 3000);
        setTimeout(function() { toast.remove(); }, 3500);
      }

      function findField(fieldName) {
        // Try multiple selector strategies for Decap CMS fields
        var selectors = [
          'input[id*="' + fieldName + '"]',
          'textarea[id*="' + fieldName + '"]',
          'input[id*="' + fieldName.toLowerCase() + '"]',
          'textarea[id*="' + fieldName.toLowerCase() + '"]',
          '[data-field-name="' + fieldName + '"] input',
          '[data-field-name="' + fieldName + '"] textarea'
        ];

        for (var i = 0; i < selectors.length; i++) {
          var el = document.querySelector(selectors[i]);
          if (el) return el;
        }

        // Try finding by label text for nested fields
        var labels = document.querySelectorAll('label');
        for (var j = 0; j < labels.length; j++) {
          var labelText = labels[j].textContent.toLowerCase();
          var searchTerms = {
            'socialCaption': ['draft tweet', 'caption'],
            'metaTitle': ['meta title'],
            'metaDesc': ['meta description'],
            'keywords': ['keywords'],
            'description': ['excerpt']
          };

          var terms = searchTerms[fieldName] || [fieldName.toLowerCase()];
          for (var k = 0; k < terms.length; k++) {
            if (labelText.includes(terms[k])) {
              var container = labels[j].closest('[class*="ControlContainer"], [class*="Field"]');
              if (container) {
                var input = container.querySelector('input, textarea');
                if (input) return input;
              }
            }
          }
        }

        return null;
      }

      function getFieldValue(fieldName) {
        var el = findField(fieldName);
        return el ? el.value : '';
      }

      function isFieldEmpty(fieldName) {
        return !getFieldValue(fieldName);
      }

      function setFieldValue(fieldName, value) {
        var el = findField(fieldName);
        if (el) {
          el.value = value;
          el.dispatchEvent(new Event('input', { bubbles: true }));
          el.dispatchEvent(new Event('change', { bubbles: true }));
          return true;
        }
        console.log('[AI SEO] Could not find field:', fieldName);
        return false;
      }

      function getEditorContent() {
        var editor = document.querySelector('[data-slate-editor="true"]');
        if (editor) return editor.textContent || '';
        var cm = document.querySelector('.CodeMirror');
        if (cm && cm.CodeMirror) return cm.CodeMirror.getValue() || '';
        var ce = document.querySelector('[contenteditable="true"]');
        if (ce) return ce.textContent || '';
        return '';
      }

      async function generateSEO(isManual) {
        if (isGenerating) return;

        var title = getFieldValue('title');
        var body = getEditorContent();

        if (!title || title.length < 10) {
          if (isManual) showStatus('Title too short (min 10 chars)', true);
          return;
        }
        if (!body || body.length < 50) {
          if (isManual) showStatus('Content too short (min 50 chars)', true);
          return;
        }

        // Skip if all fields already filled (unless manual)
        var allFilled = !isFieldEmpty('keywords') && !isFieldEmpty('metaTitle') && !isFieldEmpty('metaDesc');
        if (allFilled && !isManual) return;

        isGenerating = true;
        showStatus('Generating SEO content...');

        try {
          var response = await fetch('/.netlify/functions/generate-seo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: title, body: body })
          });

          if (!response.ok) throw new Error('API error');
          var data = await response.json();
          if (data.error) throw new Error(data.error);

          // Only fill empty fields (unless manual regenerate)
          var filled = [];
          if ((isFieldEmpty('keywords') || isManual) && data.keywords) {
            setFieldValue('keywords', data.keywords.join(', '));
            filled.push('keywords');
          }
          if ((isFieldEmpty('metaTitle') || isManual) && data.metaTitle) {
            setFieldValue('metaTitle', data.metaTitle);
            filled.push('meta title');
          }
          if ((isFieldEmpty('metaDesc') || isManual) && data.metaDesc) {
            setFieldValue('metaDesc', data.metaDesc);
            filled.push('meta desc');
          }
          if ((isFieldEmpty('description') || isManual) && data.excerpt) {
            setFieldValue('description', data.excerpt);
            filled.push('excerpt');
          }
          if ((isFieldEmpty('socialCaption') || isManual) && data.socialCaption) {
            setFieldValue('socialCaption', data.socialCaption);
            filled.push('social caption');
          }

          if (filled.length > 0) {
            showStatus('Generated: ' + filled.join(', '));
            hasGenerated = true;
          } else {
            showStatus('All fields already filled');
          }

          console.log('[AI SEO] Full response:', data);

        } catch (err) {
          console.error('[AI SEO] Error:', err);
          showStatus('Generation failed: ' + err.message, true);
        } finally {
          isGenerating = false;
        }
      }

      function checkForChanges() {
        var title = getFieldValue('title');
        var body = getEditorContent();
        var content = title + '|||' + body;

        if (content !== lastContent && title && body) {
          lastContent = content;
          clearTimeout(debounceTimer);
          // Auto-generate 3 seconds after user stops typing
          debounceTimer = setTimeout(function() {
            generateSEO(false);
          }, 3000);
        }
      }

      function addManualButton() {
        if (document.getElementById('ai-generate-btn')) return;

        var btn = document.createElement('button');
        btn.id = 'ai-generate-btn';
        btn.innerHTML = 'âœ¨ Regenerate SEO';
        btn.style.cssText = 'position:fixed;bottom:24px;right:24px;padding:12px 20px;background:linear-gradient(135deg,#8B5CF6,#6366F1);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;z-index:9999;box-shadow:0 4px 12px rgba(139,92,246,0.4);';
        btn.onclick = function() { generateSEO(true); };
        document.body.appendChild(btn);
      }

      function removeButton() {
        var btn = document.getElementById('ai-generate-btn');
        if (btn) btn.remove();
      }

      function checkEditor() {
        var url = window.location.href;
        var isBlogEditor = url.includes('/collections/blog/') || url.includes('collection=blog');

        if (isBlogEditor) {
          addManualButton();
          checkForChanges();
        } else {
          removeButton();
          hasGenerated = false;
          lastContent = '';
        }
      }

      setInterval(checkEditor, 1000);
    })();
  </script>
  {% endraw %}
</body>
</html>
